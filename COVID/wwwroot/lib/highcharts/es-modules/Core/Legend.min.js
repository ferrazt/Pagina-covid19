"use strict";import A from"./Animation/AnimationUtilities.js";var animObject=A.animObject,setAnimation=A.setAnimation;import F from"./FormatUtilities.js";var format=F.format;import H from"./Globals.js";var isFirefox=H.isFirefox,marginNames=H.marginNames,win=H.win;import Point from"./Series/Point.js";import U from"./Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,css=U.css,defined=U.defined,discardElement=U.discardElement,find=U.find,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,stableSort=U.stableSort,syncTimeout=U.syncTimeout,wrap=U.wrap,Legend=function(){function t(t,e){this.allItems=[],this.box=void 0,this.contentGroup=void 0,this.display=!1,this.group=void 0,this.initialItemY=0,this.itemHeight=0,this.itemMarginBottom=0,this.itemMarginTop=0,this.itemX=0,this.itemY=0,this.lastItemY=0,this.lastLineHeight=0,this.legendHeight=0,this.legendWidth=0,this.maxItemWidth=0,this.maxLegendWidth=0,this.offsetWidth=0,this.options={},this.padding=0,this.pages=[],this.proximate=!1,this.scrollGroup=void 0,this.symbolHeight=0,this.symbolWidth=0,this.titleHeight=0,this.totalItemWidth=0,this.widthOption=0,this.chart=t,this.init(t,e)}return t.prototype.init=function(t,e){this.chart=t,this.setOptions(e),e.enabled&&(this.render(),addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=addEvent(this.chart,"render",function(){this.legend.proximatePositions(),this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},t.prototype.setOptions=function(t){var e=pick(t.padding,8);this.options=t,this.chart.styledMode||(this.itemStyle=t.itemStyle,this.itemHiddenStyle=merge(this.itemStyle,t.itemHiddenStyle)),this.itemMarginTop=t.itemMarginTop||0,this.itemMarginBottom=t.itemMarginBottom||0,this.padding=e,this.initialItemY=e-5,this.symbolWidth=pick(t.symbolWidth,16),this.pages=[],this.proximate="proximate"===t.layout&&!this.chart.inverted,this.baseline=void 0},t.prototype.update=function(t,e){var i=this.chart;this.setOptions(merge(!0,this.options,t)),this.destroy(),i.isDirtyLegend=i.isDirtyBox=!0,pick(e,!0)&&i.redraw(),fireEvent(this,"afterUpdate")},t.prototype.colorizeItem=function(t,e){var i,s,o,n,r,h,a,l;t.legendGroup[e?"removeClass":"addClass"]("highcharts-legend-item-hidden"),this.chart.styledMode||(l=this.options,i=t.legendItem,s=t.legendLine,o=t.legendSymbol,n=this.itemHiddenStyle.color,r=e?l.itemStyle.color:n,h=e&&t.color||n,a=t.options&&t.options.marker,l={fill:h},i&&i.css({fill:r,color:r}),s&&s.attr({stroke:h}),o&&(a&&o.isMarker&&(l=t.pointAttribs(),e||(l.stroke=l.fill=n)),o.attr(l))),fireEvent(this,"afterColorizeItem",{item:t,visible:e})},t.prototype.positionItems=function(){this.allItems.forEach(this.positionItem,this),this.chart.isResizing||this.positionCheckboxes()},t.prototype.positionItem=function(t){var e=this,i=this.options,s=i.symbolPadding,o=!i.rtl,n=t._legendItemPos,r=n[0],h=n[1],i=t.checkbox,n=t.legendGroup;n&&n.element&&(o={translateX:o?r:this.legendWidth-r-2*s-4,translateY:h},s=function(){fireEvent(e,"afterPositionItem",{item:t})},defined(n.translateY)?n.animate(o,void 0,s):(n.attr(o),s())),i&&(i.x=r,i.y=h)},t.prototype.destroyItem=function(e){var t=e.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(t){e[t]&&(e[t]=e[t].destroy())}),t&&discardElement(e.checkbox)},t.prototype.destroy=function(){function e(t){this[t]&&(this[t]=this[t].destroy())}this.getAllItems().forEach(function(t){["legendItem","legendGroup"].forEach(e,t)}),["clipRect","up","down","pager","nav","box","title","group"].forEach(e,this),this.display=null},t.prototype.positionCheckboxes=function(){var s,o=this.group&&this.group.alignAttr,n=this.clipHeight||this.legendHeight,r=this.titleHeight;o&&(s=o.translateY,this.allItems.forEach(function(t){var e,i=t.checkbox;i&&(e=s+r+i.y+(this.scrollOffset||0)+3,css(i,{left:o.translateX+t.checkboxOffset+i.x-20+"px",top:e+"px",display:this.proximate||s-6<e&&e<s+n-6?"":"none"}))},this))},t.prototype.renderTitle=function(){var t=this.options,e=this.padding,i=t.title,s=0;i.text&&(this.title||(this.title=this.chart.renderer.label(i.text,e-3,e-4,null,null,null,t.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(i.style),this.title.add(this.group)),i.width||this.title.css({width:this.maxLegendWidth+"px"}),s=(i=this.title.getBBox()).height,this.offsetWidth=i.width,this.contentGroup.attr({translateY:s})),this.titleHeight=s},t.prototype.setText=function(t){var e=this.options;t.legendItem.attr({text:e.labelFormat?format(e.labelFormat,t,this.chart):e.labelFormatter.call(t)})},t.prototype.renderItem=function(t){var e=this,i=e.chart,s=i.renderer,o=e.options,n="horizontal"===o.layout,r=e.symbolWidth,h=o.symbolPadding||0,a=e.itemStyle,l=e.itemHiddenStyle,d=n?pick(o.itemDistance,20):0,c=!o.rtl,g=t.legendItem,m=!t.series,p=!m&&t.series.drawLegendSymbol?t.series:t,f=p.options,u=e.createCheckboxForItem&&f&&f.showCheckbox,v=r+h+d+(u?20:0),n=o.useHTML,f=t.options.className;g||(t.legendGroup=s.g("legend-item").addClass("highcharts-"+p.type+"-series highcharts-color-"+t.colorIndex+(f?" "+f:"")+(m?" highcharts-series-"+t.index:"")).attr({zIndex:1}).add(e.scrollGroup),t.legendItem=g=s.text("",c?r+h:-h,e.baseline||0,n),i.styledMode||g.css(merge(t.visible?a:l)),g.attr({align:c?"left":"right",zIndex:2}).add(t.legendGroup),e.baseline||(e.fontMetrics=s.fontMetrics(i.styledMode?12:a.fontSize,g),e.baseline=e.fontMetrics.f+3+e.itemMarginTop,g.attr("y",e.baseline),e.symbolHeight=o.symbolHeight||e.fontMetrics.f,o.squareSymbol&&(e.symbolWidth=pick(o.symbolWidth,Math.max(e.symbolHeight,16)),v=e.symbolWidth+h+d+(u?20:0),c&&g.attr("x",e.symbolWidth+h))),p.drawLegendSymbol(e,t),e.setItemEvents&&e.setItemEvents(t,g,n)),u&&!t.checkbox&&e.createCheckboxForItem&&e.createCheckboxForItem(t),e.colorizeItem(t,t.visible),!i.styledMode&&a.width||g.css({width:(o.itemWidth||e.widthOption||i.spacingBox.width)-v+"px"}),e.setText(t),g=g.getBBox(),t.itemWidth=t.checkboxOffset=o.itemWidth||t.legendItemWidth||g.width+v,e.maxItemWidth=Math.max(e.maxItemWidth,t.itemWidth),e.totalItemWidth+=t.itemWidth,e.itemHeight=t.itemHeight=Math.round(t.legendItemHeight||g.height||e.symbolHeight)},t.prototype.layoutItem=function(t){var e=this.options,i=this.padding,s="horizontal"===e.layout,o=t.itemHeight,n=this.itemMarginBottom,r=this.itemMarginTop,h=s?pick(e.itemDistance,20):0,a=this.maxLegendWidth,e=e.alignColumns&&this.totalItemWidth>a?this.maxItemWidth:t.itemWidth;s&&this.itemX-i+e>a&&(this.itemX=i,this.lastLineHeight&&(this.itemY+=r+this.lastLineHeight+n),this.lastLineHeight=0),this.lastItemY=r+this.itemY+n,this.lastLineHeight=Math.max(o,this.lastLineHeight),t._legendItemPos=[this.itemX,this.itemY],s?this.itemX+=e:(this.itemY+=r+o+n,this.lastLineHeight=o),this.offsetWidth=this.widthOption||Math.max((s?this.itemX-i-(t.checkbox?0:h):e)+i,this.offsetWidth)},t.prototype.getAllItems=function(){var i=[];return this.chart.series.forEach(function(t){var e=t&&t.options;t&&pick(e.showInLegend,!defined(e.linkedTo)&&void 0,!0)&&(i=i.concat(t.legendItems||("point"===e.legendType?t.data:t)))}),fireEvent(this,"afterGetAllItems",{allItems:i}),i},t.prototype.getAlignment=function(){var t=this.options;return this.proximate?t.align.charAt(0)+"tv":t.floating?"":t.align.charAt(0)+t.verticalAlign.charAt(0)+t.layout.charAt(0)},t.prototype.adjustMargins=function(i,s){var o=this.chart,n=this.options,r=this.getAlignment();r&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(t,e){t.test(r)&&!defined(i[e])&&(o[marginNames[e]]=Math.max(o[marginNames[e]],o.legend[(e+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][e]*n[e%2?"x":"y"]+pick(n.margin,12)+s[e]+(o.titleOffset[e]||0)))})},t.prototype.proximatePositions=function(){var n=this.chart,r=[],h="left"===this.options.align;this.allItems.forEach(function(t){var e,i,s,o=h;t.yAxis&&(t.xAxis.options.reversed&&(o=!o),t.points&&(e=find(o?t.points:t.points.slice(0).reverse(),function(t){return isNumber(t.plotY)})),i=this.itemMarginTop+t.legendItem.getBBox().height+this.itemMarginBottom,o=t.yAxis.top-n.plotTop,t.visible?(s=e?e.plotY:t.yAxis.height,s+=o-.3*i):s=o+t.yAxis.height,r.push({target:s,size:i,item:t}))},this),H.distribute(r,n.plotHeight),r.forEach(function(t){t.item._legendItemPos[1]=n.plotTop-n.spacing[0]+t.pos})},t.prototype.render=function(){var t,e,i,s=this,o=s.chart,n=o.renderer,r=s.group,h=s.box,a=s.options,l=s.padding;s.itemX=l,s.itemY=s.initialItemY,s.offsetWidth=0,s.lastItemY=0,s.widthOption=relativeLength(a.width,o.spacingBox.width-l),i=o.spacingBox.width-2*l-a.x,-1<["rm","lm"].indexOf(s.getAlignment().substring(0,2))&&(i/=2),s.maxLegendWidth=s.widthOption||i,r||(s.group=r=n.g("legend").addClass(a.className||"").attr({zIndex:7}).add(),s.contentGroup=n.g().attr({zIndex:1}).add(r),s.scrollGroup=n.g().add(s.contentGroup)),s.renderTitle(),e=s.getAllItems(),stableSort(e,function(t,e){return(t.options&&t.options.legendIndex||0)-(e.options&&e.options.legendIndex||0)}),a.reversed&&e.reverse(),s.allItems=e,s.display=t=!!e.length,s.lastLineHeight=0,s.maxItemWidth=0,s.totalItemWidth=0,s.itemHeight=0,e.forEach(s.renderItem,s),e.forEach(s.layoutItem,s),i=(s.widthOption||s.offsetWidth)+l,e=s.lastItemY+s.lastLineHeight+s.titleHeight,e=s.handleOverflow(e),e+=l,h||(s.box=h=n.rect().addClass("highcharts-legend-box").attr({r:a.borderRadius}).add(r),h.isNew=!0),o.styledMode||h.attr({stroke:a.borderColor,"stroke-width":a.borderWidth||0,fill:a.backgroundColor||"none"}).shadow(a.shadow),0<i&&0<e&&(h[h.isNew?"attr":"animate"](h.crisp.call({},{x:0,y:0,width:i,height:e},h.strokeWidth())),h.isNew=!1),h[t?"show":"hide"](),o.styledMode&&"none"===r.getStyle("display")&&(i=e=0),s.legendWidth=i,s.legendHeight=e,t&&s.align(),this.proximate||this.positionItems(),fireEvent(this,"afterRender")},t.prototype.align=function(t){void 0===t&&(t=this.chart.spacingBox);var e=this.chart,i=this.options,s=t.y;/(lth|ct|rth)/.test(this.getAlignment())&&0<e.titleOffset[0]?s+=e.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&0<e.titleOffset[2]&&(s-=e.titleOffset[2]),s!==t.y&&(t=merge(t,{y:s})),this.group.align(merge(i,{width:this.legendWidth,height:this.legendHeight,verticalAlign:this.proximate?"top":i.verticalAlign}),!0,t)},t.prototype.handleOverflow=function(t){var n,r,e=this,i=this.chart,s=i.renderer,o=this.options,h=o.y,a="top"===o.verticalAlign,l=this.padding,d=i.spacingBox.height+(a?-h:h)-l,c=o.maxHeight,g=this.clipRect,m=o.navigation,p=pick(m.animation,!0),f=m.arrowSize||12,u=this.nav,v=this.pages,y=this.allItems,a=function(t){"number"==typeof t?g.attr({height:t}):g&&(e.clipRect=g.destroy(),e.contentGroup.clip()),e.contentGroup.div&&(e.contentGroup.div.style.clip=t?"rect("+l+"px,9999px,"+(l+t)+"px,0)":"auto")},h=function(t){return e[t]=s.circle(0,0,1.3*f).translate(f/2,f/2).add(u),i.styledMode||e[t].attr("fill","rgba(0,0,0,0.0001)"),e[t]};return"horizontal"!==o.layout||"middle"===o.verticalAlign||o.floating||(d/=2),c&&(d=Math.min(d,c)),v.length=0,t&&0<d&&d<t&&!1!==m.enabled?(this.clipHeight=n=Math.max(d-20-this.titleHeight-l,0),this.currentPage=pick(this.currentPage,1),this.fullHeight=t,y.forEach(function(t,e){var i=t._legendItemPos[1],s=Math.round(t.legendItem.getBBox().height),o=v.length;(!o||i-v[o-1]>n&&(r||i)!==v[o-1])&&(v.push(r||i),o++),t.pageIx=o-1,r&&(y[e-1].pageIx=o-1),e===y.length-1&&i+s-v[o-1]>n&&i!==r&&(v.push(i),t.pageIx=o),i!==r&&(r=i)}),g||(g=e.clipRect=s.clipRect(0,l,9999,0),e.contentGroup.clip(g)),a(n),u||(this.nav=u=s.g().attr({zIndex:1}).add(this.group),this.up=s.symbol("triangle",0,0,f,f).add(u),h("upTracker").on("click",function(){e.scroll(-1,p)}),this.pager=s.text("",15,10).addClass("highcharts-legend-navigation"),i.styledMode||this.pager.css(m.style),this.pager.add(u),this.down=s.symbol("triangle-down",0,0,f,f).add(u),h("downTracker").on("click",function(){e.scroll(1,p)})),e.scroll(0),t=d):u&&(a(),this.nav=u.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0),t},t.prototype.scroll=function(t,e){var i=this,s=this.chart,o=this.pages,n=o.length,r=this.currentPage+t,h=this.clipHeight,a=this.options.navigation,l=this.pager,t=this.padding;0<(r=n<r?n:r)&&(void 0!==e&&setAnimation(e,s),this.nav.attr({translateX:t,translateY:h+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(t){t.attr({class:1===r?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),l.attr({text:r+"/"+n}),[this.down,this.downTracker].forEach(function(t){t.attr({x:18+this.pager.getBBox().width,class:r===n?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),s.styledMode||(this.up.attr({fill:1===r?a.inactiveColor:a.activeColor}),this.upTracker.css({cursor:1===r?"default":"pointer"}),this.down.attr({fill:r===n?a.inactiveColor:a.activeColor}),this.downTracker.css({cursor:r===n?"default":"pointer"})),this.scrollOffset=-o[r-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=r,this.positionCheckboxes(),s=animObject(pick(e,s.renderer.globalAnimation,!0)),syncTimeout(function(){fireEvent(i,"afterScroll",{currentPage:r})},s.duration))},t.prototype.setItemEvents=function(s,e,t){var o=this,n=o.chart.renderer.boxWrapper,r=s instanceof Point,h="highcharts-legend-"+(r?"point":"series")+"-active",i=o.chart.styledMode;(t?[e,s.legendSymbol]:[s.legendGroup]).forEach(function(t){t&&t.on("mouseover",function(){s.visible&&o.allItems.forEach(function(t){s!==t&&t.setState("inactive",!r)}),s.setState("hover"),s.visible&&n.addClass(h),i||e.css(o.options.itemHoverStyle)}).on("mouseout",function(){o.chart.styledMode||e.css(merge(s.visible?o.itemStyle:o.itemHiddenStyle)),o.allItems.forEach(function(t){s!==t&&t.setState("",!r)}),n.removeClass(h),s.setState()}).on("click",function(t){function e(){s.setVisible&&s.setVisible(),o.allItems.forEach(function(t){s!==t&&t.setState(s.visible?"inactive":"",!r)})}var i="legendItemClick";n.removeClass(h),t={browserEvent:t},s.firePointEvent?s.firePointEvent(i,t,e):fireEvent(s,i,t,e)})})},t.prototype.createCheckboxForItem=function(e){e.checkbox=createElement("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:e.selected,defaultChecked:e.selected},this.options.itemCheckboxStyle,this.chart.container),addEvent(e.checkbox,"click",function(t){t=t.target;fireEvent(e.series||e,"checkboxClick",{checked:t.checked,item:e},function(){e.select()})})},t}();(/Trident\/7\.0/.test(win.navigator&&win.navigator.userAgent)||isFirefox)&&wrap(Legend.prototype,"positionItem",function(t,e){function i(){e._legendItemPos&&t.call(s,e)}var s=this;i(),s.bubbleLegend||setTimeout(i)}),H.Legend=Legend;export default H.Legend;