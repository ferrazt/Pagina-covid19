"use strict";import Axis from"./Axis.js";import Chart from"../Chart/Chart.js";import H from"../Globals.js";import Series from"../Series/Series.js";import U from"../Utilities.js";var OrdinalAxis,addEvent=U.addEvent,correctFloat=U.correctFloat,css=U.css,defined=U.defined,error=U.error,pick=U.pick,timeUnits=U.timeUnits;import"../Navigator.js";!function(e){var t=(r.prototype.beforeSetTickPositions=function(){var o,n,t,i,e,r,a=this.axis,s=a.ordinal,l=[],d=!1,p=a.getExtremes(),c=p.min,f=p.max,h=a.isXAxis&&!!a.options.breaks,v=a.options.ordinal,u=Number.MAX_VALUE,g=a.chart.options.chart.ignoreHiddenSeries;if(v||h){if(a.series.forEach(function(t,i){if(n=[],(!g||!1!==t.visible)&&(!1!==t.takeOrdinalPosition||h)&&(l=l.concat(t.processedXData),o=l.length,l.sort(function(t,i){return t-i}),u=Math.min(u,pick(t.closestPointRange,u)),o)){for(i=0;i<o-1;)l[i]!==l[i+1]&&n.push(l[i+1]),i++;n[0]!==l[0]&&n.unshift(l[0]),l=n}t.isSeriesBoosting&&(r=!0)}),r&&(l.length=0),2<(o=l.length)){for(t=l[1]-l[0],e=o-1;e--&&!d;)l[e+1]-l[e]!=t&&(d=!0);!a.options.keepOrdinalPadding&&(l[0]-c>t||f-l[l.length-1]>t)&&(d=!0)}else a.options.overscroll&&(2===o?u=l[1]-l[0]:1===o?(u=a.options.overscroll,l=[l[0],l[0]+u]):u=s.overscrollPointsRange);d||a.forceOrdinal?(a.options.overscroll&&(s.overscrollPointsRange=u,l=l.concat(s.getOverscrollPositions())),s.positions=l,i=a.ordinal2lin(Math.max(c,l[0]),!0),p=Math.max(a.ordinal2lin(Math.min(f,l[l.length-1]),!0),1),s.slope=p=(f-c)/(p-i),s.offset=c-i*p):(s.overscrollPointsRange=pick(a.closestPointRange,s.overscrollPointsRange),s.positions=a.ordinal.slope=s.offset=void 0)}a.isOrdinal=v&&d,s.groupIntervalFactor=null},r.findIndexOf=function(t,i,o){for(var n,e=0,r=t.length-1;e<=r;){if(t[n=Math.floor((e+r)/2)]===i)return n;t[n]<i?e=n+1:r=n-1}return o?n:-1},r.prototype.getExtendedPositions=function(){var i,o,n=this,t=n.axis,e=t.constructor.prototype,r=t.chart,a=t.series[0].currentDataGrouping,s=n.index,l=a?a.count+a.unitName:"raw",d=t.options.overscroll,p=t.getExtremes();return(s=s||(n.index={}))[l]||((i={series:[],chart:r,forceOrdinal:!1,getExtremes:function(){return{min:p.dataMin,max:p.dataMax+d}},getGroupPixelWidth:e.getGroupPixelWidth,getTimeTicks:e.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:e.ordinal2lin,val2lin:e.val2lin}).ordinal.axis=i,t.series.forEach(function(t){(o={xAxis:i,xData:t.xData.slice(),chart:r,destroyGroupedData:H.noop,getProcessedData:Series.prototype.getProcessedData}).xData=o.xData.concat(n.getOverscrollPositions()),o.options={dataGrouping:a?{enabled:!0,forced:!0,approximation:"open",units:[[a.unitName,[a.count]]]}:{enabled:!1}},i.series.push(o),t.processData.apply(o),o.closestPointRange!==o.basePointRange&&o.currentDataGrouping&&(i.forceOrdinal=!0)}),t.ordinal.beforeSetTickPositions.apply({axis:i}),s[l]=i.ordinal.positions),s[l]},r.prototype.getGroupIntervalFactor=function(t,i,o){var n,e=this,r=(e.axis,o.processedXData),a=r.length,s=[],l=e.groupIntervalFactor;if(!l){for(n=0;n<a-1;n++)s[n]=r[n+1]-r[n];s.sort(function(t,i){return t-i}),o=s[Math.floor(a/2)],t=Math.max(t,r[0]),i=Math.min(i,r[a-1]),e.groupIntervalFactor=l=a*o/(i-t)}return l},r.prototype.getIndexOfPoint=function(t,i){var o=this,n=o.axis,e=o.positions?o.positions[0]:0,o=(t-(o.slope?o.slope*n.transA:0))/(n.translationSlope*(o.slope||n.closestPointRange||o.overscrollPointsRange));return r.findIndexOf(i,e)+o},r.prototype.getOverscrollPositions=function(){var t=this.axis,i=t.options.overscroll,o=this.overscrollPointsRange,n=[],e=t.dataMax;if(defined(o))for(n.push(e);e<=t.dataMax+i;)n.push(e+=o);return n},r.prototype.postProcessTickInterval=function(t){var i=this.axis,o=this.slope,t=o?i.options.breaks?i.closestPointRange||t:t/(o/i.closestPointRange):t;return t},r);function r(t){this.index={},this.axis=t}e.Composition=t,e.compose=function(t,i,o){t.keepProps.push("ordinal");var n=t.prototype;t.prototype.getTimeTicks=function(t,i,o,n,e,r,a){void 0===e&&(e=[]),void 0===r&&(r=0);var s,l,d,p,c,f,h=0,v={},u=[],g=-Number.MAX_VALUE,x=this.options.tickPixelInterval,m=this.chart.time,P=[];if(!this.options.ordinal&&!this.options.breaks||!e||e.length<3||void 0===i)return m.getTimeTicks.apply(m,arguments);for(c=e.length,s=0;s<c;s++){if(f=s&&e[s-1]>o,e[s]<i&&(h=s),s===c-1||e[s+1]-e[s]>5*r||f){if(e[s]>g){for(l=m.getTimeTicks(t,e[h],e[s],n);l.length&&l[0]<=g;)l.shift();l.length&&(g=l[l.length-1]),P.push(u.length),u=u.concat(l)}h=s+1}if(f)break}if(l){if(p=l.info,a&&p.unitRange<=timeUnits.hour){for(s=u.length-1,h=1;h<s;h++)m.dateFormat("%d",u[h])!==m.dateFormat("%d",u[h-1])&&(v[u[h]]="day",d=!0);d&&(v[u[0]]="day"),p.higherRanks=v}p.segmentStarts=P,u.info=p}else error(12,!1,this.chart);if(a&&defined(x)){for(var M,a=u.length,k=a,y=void 0,A=void 0,E=[],O=void 0,D=void 0,I=[];k--;)A=this.translate(u[k]),O&&(I[k]=O-A),E[k]=O=A;for(I.sort(),(D=I[Math.floor(I.length/2)])<.6*x&&(D=null),k=u[a-1]>o?a-1:a,O=void 0;k--;)A=E[k],M=Math.abs(O-A),O&&M<.8*x&&(null===D||M<.8*D)?(v[u[k]]&&!v[u[k+1]]?(y=k+1,O=A):y=k,u.splice(y,1)):O=A}return u},n.index2val=function(t){var i=this.ordinal.positions;if(!i)return t;var o,n=i.length-1;return t<0?t=i[0]:n<t?t=i[n]:o=t-(n=Math.floor(t)),void 0!==o&&void 0!==i[n]?i[n]+(o?o*(i[n+1]-i[n]):0):t},n.lin2val=function(t){var i=this,o=i.ordinal,n=t>i.left&&t<i.left+i.len,e=(i.old||i).min,r=(i.old||i).transA,i=o.positions;if(!i)return t;r*=t-e;if(n||(o.extendedOrdinalPositions||(o.extendedOrdinalPositions=o.getExtendedPositions()),i=o.extendedOrdinalPositions),i&&i.length){o=o.getIndexOfPoint(r,i),r=correctFloat(o%1);if(0<=o&&o<i.length){var a=i[Math.floor(o)],s=i[Math.ceil(o)]-a;return i[Math.floor(o)]+r*s}a=i.length,r=i[0],s=i[a-1],i=(s-r)/(a-1);return o<0?r+i*o:s+i*(o-a)}return t},n.val2lin=function(t,i){var o=this.ordinal,n=o.positions;if(n){for(var e=n.length,r=void 0,a=void 0,r=e;r--;)if(n[r]===t){a=r;break}for(r=e-1;r--;)if(t>n[r]||0===r){a=r+(t-n[r])/(n[r+1]-n[r]);break}e=i?a:o.slope*(a||0)+o.offset}else e=t;return e},n.ordinal2lin=n.val2lin,addEvent(t,"afterInit",function(){this.ordinal||(this.ordinal=new e.Composition(this))}),addEvent(t,"foundExtremes",function(){var t=this;t.isXAxis&&defined(t.options.overscroll)&&t.max===t.dataMax&&(!t.chart.mouseIsDown||t.isInternal)&&(!t.eventArgs||t.eventArgs&&"navigator"!==t.eventArgs.trigger)&&(t.max+=t.options.overscroll,!t.isInternal&&defined(t.userMin)&&(t.min+=t.options.overscroll))}),addEvent(t,"afterSetScale",function(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}),addEvent(t,"initialAxisTranslation",function(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}),addEvent(i,"pan",function(t){var i,o,n,e,r,a,s,l,d,p,c,f,h,v=this,u=v.xAxis[0],g=u.options.overscroll,x=t.originalEvent.chartX,m=v.options.chart.panning,P=!1;m&&"y"!==m.type&&u.options.ordinal&&u.series.length?(p=v.mouseDownX,o=(i=u.getExtremes()).dataMax,n=i.min,e=i.max,r=void 0,a=v.hoverPoints,h=u.closestPointRange||u.ordinal&&u.ordinal.overscrollPointsRange,s=(p-x)/(u.translationSlope*(u.ordinal.slope||h)),l={ordinal:{positions:u.ordinal.getExtendedPositions()}},c=u.index2val,f=u.val2lin,h=p=d=void 0,l.ordinal.positions?1<Math.abs(s)&&(a&&a.forEach(function(t){t.setState()}),o>(d=(h=s<0?(p=l,u.ordinal.positions?u:l):(p=u.ordinal.positions?u:l,l)).ordinal.positions)[d.length-1]&&d.push(o),v.fixedRange=e-n,(r=u.navigatorAxis.toFixedRange(null,null,c.apply(p,[f.apply(p,[n,!0])+s]),c.apply(h,[f.apply(h,[e,!0])+s]))).min>=Math.min(i.dataMin,n)&&r.max<=Math.max(o,e)+g&&u.setExtremes(r.min,r.max,!0,!1,{trigger:"pan"}),v.mouseDownX=x,css(v.container,{cursor:"move"})):P=!0):P=!0,P||m&&/y/.test(m.type)?g&&(u.max=u.dataMax+g):t.preventDefault()}),addEvent(o,"updatedData",function(){var t=this.xAxis;t&&t.options.ordinal&&delete t.ordinal.index})}}(OrdinalAxis=OrdinalAxis||{}),OrdinalAxis.compose(Axis,Chart,Series);export default OrdinalAxis;