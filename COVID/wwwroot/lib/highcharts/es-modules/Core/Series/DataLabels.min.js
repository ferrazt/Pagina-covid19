"use strict";import A from"../Animation/AnimationUtilities.js";var getDeferredAnimation=A.getDeferredAnimation;import F from"../FormatUtilities.js";var format=F.format;import H from"../Globals.js";var noop=H.noop;import palette from"../Color/Palette.js";import Series from"../Series/Series.js";import SeriesRegistry from"./SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import U from"../Utilities.js";var arrayMax=U.arrayMax,clamp=U.clamp,defined=U.defined,extend=U.extend,fireEvent=U.fireEvent,isArray=U.isArray,merge=U.merge,objectEach=U.objectEach,pick=U.pick,relativeLength=U.relativeLength,splat=U.splat,stableSort=U.stableSort;H.distribute=function(t,a,i){var o,e,r,s=!0,n=t,l=[],d=0,h=n.reducedLen||a;function c(t,e){return t.target-e.target}for(o=t.length;o--;)d+=t[o].size;if(h<d){for(stableSort(t,function(t,e){return(e.rank||0)-(t.rank||0)}),d=o=0;d<=h;)d+=t[o].size,o++;l=t.splice(o-1,t.length)}for(stableSort(t,c),t=t.map(function(t){return{size:t.size,targets:[t.target],align:pick(t.align,.5)}});s;){for(o=t.length;o--;)e=t[o],r=(Math.min.apply(0,e.targets)+Math.max.apply(0,e.targets))/2,e.pos=clamp(r-e.size*e.align,0,a-e.size);for(o=t.length,s=!1;o--;)0<o&&t[o-1].pos+t[o-1].size>t[o].pos&&(t[o-1].size+=t[o].size,t[o-1].targets=t[o-1].targets.concat(t[o].targets),t[o-1].align=.5,t[o-1].pos+t[o-1].size>a&&(t[o-1].pos=a-t[o-1].size),t.splice(o,1),s=!0)}n.push.apply(n,l),o=0,t.some(function(t){var e=0;if(t.targets.some(function(){return n[o].pos=t.pos+e,void 0!==i&&Math.abs(n[o].pos-n[o].target)>i?(n.slice(0,o+1).forEach(function(t){delete t.pos}),n.reducedLen=(n.reducedLen||a)-.1*a,n.reducedLen>.1*a&&H.distribute(n,a,i),!0):(e+=n[o].size,void o++)}))return!0}),stableSort(n,c)},Series.prototype.drawDataLabels=function(){var p,b=this,g=b.chart,f=b.options,t=f.dataLabels,e=b.points,a=b.hasRendered||0,i=t.animation,i=t.defer?getDeferredAnimation(g,i,b):{defer:0,duration:0},u=g.renderer;function o(e,a){var t,i=[];if(isArray(e)&&!isArray(a))i=e.map(function(t){return merge(t,a)});else if(isArray(a)&&!isArray(e))i=a.map(function(t){return merge(e,t)});else if(isArray(e)||isArray(a))for(t=Math.max(e.length,a.length);t--;)i[t]=merge(e[t],a[t]);else i=merge(e,a);return i}t=o(o(g.options.plotOptions&&g.options.plotOptions.series&&g.options.plotOptions.series.dataLabels,g.options.plotOptions&&g.options.plotOptions[b.type]&&g.options.plotOptions[b.type].dataLabels),t),fireEvent(this,"drawDataLabels"),(isArray(t)||t.enabled||b._hasPointLabels)&&((p=b.plotGroup("dataLabelsGroup","data-labels",a?"inherit":"hidden",t.zIndex||6)).attr({opacity:+a}),a||(a=b.dataLabelsGroup)&&(b.visible&&p.show(!0),a[f.animation?"animate":"attr"]({opacity:1},i)),e.forEach(function(c){splat(o(t,c.dlOptions||c.options&&c.options.dataLabels)).forEach(function(t,e){var a,i,o,r,s,n,l,d=t.enabled&&(!c.isNull||c.dataLabelOnNull)&&(s=c,!(l=(n=t).filter)||(n=l.operator,s=s[l.property],l=l.value,">"===n&&l<s||"<"===n&&s<l||">="===n&&l<=s||"<="===n&&s<=l||"=="===n&&s==l||"==="===n&&s===l)),h=c.dataLabels?c.dataLabels[e]:c.dataLabel,n=c.connectors?c.connectors[e]:c.connector,s=pick(t.distance,c.labelDistance),l=!h;d&&(o=c.getLabelConfig(),i=pick(t[c.formatPrefix+"Format"],t.format),a=defined(i)?format(i,o,g):(t[c.formatPrefix+"Formatter"]||t.formatter).call(o,t),i=t.style,o=t.rotation,g.styledMode||(i.color=pick(t.color,i.color,b.color,palette.neutralColor100),"contrast"===i.color?(c.contrastColor=u.getContrast(c.color||b.color),i.color=!defined(s)&&t.inside||s<0||f.stacking?c.contrastColor:palette.neutralColor100):delete c.contrastColor,f.cursor&&(i.cursor=f.cursor)),r={r:t.borderRadius||0,rotation:o,padding:t.padding,zIndex:1},g.styledMode||(r.fill=t.backgroundColor,r.stroke=t.borderColor,r["stroke-width"]=t.borderWidth),objectEach(r,function(t,e){void 0===t&&delete r[e]})),!h||d&&defined(a)?d&&defined(a)&&(h?r.text=a:(c.dataLabels=c.dataLabels||[],h=c.dataLabels[e]=o?u.text(a,0,-9999,t.useHTML).addClass("highcharts-data-label"):u.label(a,0,-9999,t.shape,null,null,t.useHTML,null,"data-label"),e||(c.dataLabel=h),h.addClass(" highcharts-data-label-color-"+c.colorIndex+" "+(t.className||"")+(t.useHTML?" highcharts-tracker":""))),h.options=t,h.attr(r),g.styledMode||h.css(i).shadow(t.shadow),h.added||h.add(p),t.textPath&&!t.useHTML&&(h.setTextPath(c.getDataLabelPath&&c.getDataLabelPath(h)||c.graphic,t.textPath),c.dataLabelPath&&!t.textPath.enabled&&(c.dataLabelPath=c.dataLabelPath.destroy())),b.alignDataLabel(c,h,t,null,l)):(c.dataLabel=c.dataLabel&&c.dataLabel.destroy(),c.dataLabels&&(1===c.dataLabels.length?delete c.dataLabels:delete c.dataLabels[e]),e||delete c.dataLabel,n&&(c.connector=c.connector.destroy(),c.connectors&&(1===c.connectors.length?delete c.connectors:delete c.connectors[e])))})})),fireEvent(this,"afterDrawDataLabels")},Series.prototype.alignDataLabel=function(e,a,t,i,o){function r(t){c&&l.xAxis&&!L&&l.setDataLabelStartPos(e,a,o,y,t)}var s,n,l=this,d=this.chart,h=this.isCartesian&&d.inverted,c=this.enabledDataSorting,p=pick(e.dlBox&&e.dlBox.centerX,e.plotX,-9999),b=pick(e.plotY,-9999),g=a.getBBox(),f=t.rotation,u=t.align,y=d.isInsidePlot(p,Math.round(b),{inverted:h,paneCoordinates:!0,series:l}),L="justify"===pick(t.overflow,c?"none":"justify"),x=this.visible&&!1!==e.visible&&(e.series.forceDL||c&&!L||y||pick(t.inside,!!this.options.stacking)&&i&&d.isInsidePlot(p,h?i.x+1:i.y+i.height-1,{inverted:h,paneCoordinates:!0,series:l}));x&&(s=d.renderer.fontMetrics(d.styledMode?void 0:t.style.fontSize,a).b,i=extend({x:h?this.yAxis.len-b:p,y:Math.round(h?this.xAxis.len-p:b),width:0,height:0},i),extend(t,{width:g.width,height:g.height}),f?(L=!1,s=d.renderer.rotCorr(s,f),r(n={x:i.x+(t.x||0)+i.width/2+s.x,y:i.y+(t.y||0)+{top:0,middle:.5,bottom:1}[t.verticalAlign]*i.height}),a[o?"attr":"animate"](n).attr({align:u}),s=180<(s=(f+720)%360)&&s<360,"left"===u?n.y-=s?g.height:0:"center"===u?(n.x-=g.width/2,n.y-=g.height/2):"right"===u&&(n.x-=g.width,n.y-=s?0:g.height),a.placed=!0,a.alignAttr=n):(r(i),a.align(t,void 0,i),n=a.alignAttr),L&&0<=i.height?this.justifyDataLabel(a,t,n,g,i,o):pick(t.crop,!0)&&(x=d.isInsidePlot(n.x,n.y,{paneCoordinates:!0,series:l})&&d.isInsidePlot(n.x+g.width,n.y+g.height,{paneCoordinates:!0,series:l})),t.shape&&!f&&a[o?"attr":"animate"]({anchorX:h?d.plotWidth-e.plotY:e.plotX,anchorY:h?d.plotHeight-e.plotX:e.plotY})),o&&c&&(a.placed=!1),x||c&&!L||(a.hide(!0),a.placed=!1)},Series.prototype.setDataLabelStartPos=function(t,e,a,i,o){var r=this.chart,s=r.inverted,n=this.xAxis,l=n.reversed,d=s?e.height/2:e.width/2,t=t.pointWidth,t=t?t/2:0,n=s?o.x:l?-d-t:n.width-d+t,o=s?l?this.yAxis.height-d+t:-d-t:o.y;e.startXPos=n,e.startYPos=o,i?"hidden"===e.visibility&&(e.show(),e.attr({opacity:0}).animate({opacity:1})):e.attr({opacity:1}).animate({opacity:0},void 0,e.hide),r.hasRendered&&(a&&e.attr({x:e.startXPos,y:e.startYPos}),e.placed=!0)},Series.prototype.justifyDataLabel=function(t,e,a,i,o,r){var s,n=this.chart,l=e.align,d=e.verticalAlign,h=!t.box&&t.padding||0,c=e.x,p=void 0===c?0:c,b=e.y,c=void 0===b?0:b,b=(a.x||0)+h;return b<0&&("right"===l&&0<=p?(e.align="left",e.inside=!0):p-=b,s=!0),(b=(a.x||0)+i.width-h)>n.plotWidth&&("left"===l&&p<=0?(e.align="right",e.inside=!0):p+=n.plotWidth-b,s=!0),(b=a.y+h)<0&&("bottom"===d&&0<=c?(e.verticalAlign="top",e.inside=!0):c-=b,s=!0),(b=(a.y||0)+i.height-h)>n.plotHeight&&("top"===d&&c<=0?(e.verticalAlign="bottom",e.inside=!0):c+=n.plotHeight-b,s=!0),s&&(e.x=p,e.y=c,t.placed=!r,t.align(e,void 0,o)),s},seriesTypes.pie&&(seriesTypes.pie.prototype.dataLabelPositioners={radialDistributionY:function(t){return t.top+t.distributeBox.pos},radialDistributionX:function(t,e,a,i){return t.getX(a<e.top+2||a>e.bottom-2?i:a,e.half,e)},justify:function(t,e,a){return a[0]+(t.half?-1:1)*(e+t.labelDistance)},alignToPlotEdges:function(t,e,a,i){t=t.getBBox().width;return e?t+i:a-t-i},alignToConnectors:function(t,e,a,i){var o,r=0;return t.forEach(function(t){o=t.dataLabel.getBBox().width,r<o&&(r=o)}),e?r+i:a-r-i}},seriesTypes.pie.prototype.drawDataLabels=function(){var d,a,i,h,c,p,b,g,f,u,y,L=this,t=L.data,x=L.chart,m=L.options.dataLabels||{},v=m.connectorPadding,w=x.plotWidth,D=x.plotHeight,M=x.plotLeft,e=Math.round(x.chartWidth/3),A=L.center,k=A[2]/2,P=A[1],o=[[],[]],C=[0,0,0,0],B=L.dataLabelPositioners;L.visible&&(m.enabled||L._hasPointLabels)&&(t.forEach(function(t){t.dataLabel&&t.visible&&t.dataLabel.shortened&&(t.dataLabel.attr({width:"auto"}).css({width:"auto",textOverflow:"clip"}),t.dataLabel.shortened=!1)}),Series.prototype.drawDataLabels.apply(L),t.forEach(function(t){t.dataLabel&&(t.visible?(o[t.half].push(t),t.dataLabel._pos=null,defined(m.style.width)||defined(t.options.dataLabels&&t.options.dataLabels.style&&t.options.dataLabels.style.width)||t.dataLabel.getBBox().width>e&&(t.dataLabel.css({width:Math.round(.7*e)+"px"}),t.dataLabel.shortened=!0)):(t.dataLabel=t.dataLabel.destroy(),t.dataLabels&&1===t.dataLabels.length&&delete t.dataLabels))}),o.forEach(function(t,e){var a,i,o,r,s,n=t.length,l=[];if(n)for(L.sortByAngle(t,e-.5),0<L.maxLabelDistance&&(s=Math.max(0,P-k-L.maxLabelDistance),a=Math.min(P+k+L.maxLabelDistance,x.plotHeight),t.forEach(function(t){0<t.labelDistance&&t.dataLabel&&(t.top=Math.max(0,P-k-t.labelDistance),t.bottom=Math.min(P+k+t.labelDistance,x.plotHeight),r=t.dataLabel.getBBox().height||21,t.distributeBox={target:t.labelPosition.natural.y-t.top+r/2,size:r,rank:t.y},l.push(t.distributeBox))}),s=a+r-s,H.distribute(l,s,s/5)),u=0;u<n;u++){if(d=t[u],c=d.labelPosition,h=d.dataLabel,f=!1===d.visible?"hidden":"inherit",i=c.natural.y,g=i,l&&defined(d.distributeBox)&&(void 0===d.distributeBox.pos?f="hidden":(p=d.distributeBox.size,g=B.radialDistributionY(d))),delete d.positionIndex,m.justify)b=B.justify(d,k,A);else switch(m.alignTo){case"connectors":b=B.alignToConnectors(t,e,w,M);break;case"plotEdges":b=B.alignToPlotEdges(h,e,w,M);break;default:b=B.radialDistributionX(L,d,g,i)}h._attr={visibility:f,align:c.alignment},y=d.options.dataLabels||{},h._pos={x:b+pick(y.x,m.x)+({left:v,right:-v}[c.alignment]||0),y:g+pick(y.y,m.y)-10},c.final.x=b,c.final.y=g,pick(m.crop,!0)&&(c=h.getBBox().width,o=null,b-c<v&&1===e?(o=Math.round(c-b+v),C[3]=Math.max(o,C[3])):w-v<b+c&&0===e&&(o=Math.round(b+c-w+v),C[1]=Math.max(o,C[1])),g-p/2<0?C[0]=Math.max(Math.round(p/2-g),C[0]):D<g+p/2&&(C[2]=Math.max(Math.round(g+p/2-D),C[2])),h.sideOverflow=o)}}),0!==arrayMax(C)&&!this.verifyDataLabelOverflow(C)||(this.placeDataLabels(),this.points.forEach(function(t){var e;y=merge(m,t.options.dataLabels),(a=pick(y.connectorWidth,1))&&(e=void 0,i=t.connector,(h=t.dataLabel)&&h._pos&&t.visible&&0<t.labelDistance?(f=h._attr.visibility,(e=!i)&&(t.connector=i=x.renderer.path().addClass("highcharts-data-label-connector  highcharts-color-"+t.colorIndex+(t.className?" "+t.className:"")).add(L.dataLabelsGroup),x.styledMode||i.attr({"stroke-width":a,stroke:y.connectorColor||t.color||palette.neutralColor60})),i[e?"attr":"animate"]({d:t.getConnectorPath()}),i.attr("visibility",f)):i&&(t.connector=i.destroy()))})))},seriesTypes.pie.prototype.placeDataLabels=function(){this.points.forEach(function(t){var e,a=t.dataLabel;a&&t.visible&&((e=a._pos)?(a.sideOverflow&&(a._attr.width=Math.max(a.getBBox().width-a.sideOverflow,0),a.css({width:a._attr.width+"px",textOverflow:(this.options.dataLabels.style||{}).textOverflow||"ellipsis"}),a.shortened=!0),a.attr(a._attr),a[a.moved?"animate":"attr"](e),a.moved=!0):a&&a.attr({y:-9999})),delete t.distributeBox},this)},seriesTypes.pie.prototype.alignDataLabel=noop,seriesTypes.pie.prototype.verifyDataLabelOverflow=function(t){var e=this.center,a=this.options,i=a.center,o=a.minSize||80,r=o,s=null!==a.size;return s||(null!==i[0]?r=Math.max(e[2]-Math.max(t[1],t[3]),o):(r=Math.max(e[2]-t[1]-t[3],o),e[0]+=(t[3]-t[1])/2),null!==i[1]?r=clamp(r,o,e[2]-Math.max(t[0],t[2])):(r=clamp(r,o,e[2]-t[0]-t[2]),e[1]+=(t[0]-t[2])/2),r<e[2]?(e[2]=r,e[3]=Math.min(relativeLength(a.innerSize||0,r),r),this.translate(e),this.drawDataLabels&&this.drawDataLabels()):s=!0),s}),seriesTypes.column&&(seriesTypes.column.prototype.alignDataLabel=function(t,e,a,i,o){var r=this.chart.inverted,s=t.series,n=t.dlBox||t.shapeArgs,l=pick(t.below,t.plotY>pick(this.translatedThreshold,s.yAxis.len)),d=pick(a.inside,!!this.options.stacking);n&&((i=merge(n)).y<0&&(i.height+=i.y,i.y=0),0<(n=i.y+i.height-s.yAxis.len)&&n<i.height&&(i.height-=n),r&&(i={x:s.yAxis.len-i.y-i.height,y:s.xAxis.len-i.x-i.width,width:i.height,height:i.width}),d||(r?(i.x+=l?0:i.width,i.width=0):(i.y+=l?i.height:0,i.height=0))),a.align=pick(a.align,!r||d?"center":l?"right":"left"),a.verticalAlign=pick(a.verticalAlign,r||d?"middle":l?"top":"bottom"),Series.prototype.alignDataLabel.call(this,t,e,a,i,o),a.inside&&t.contrastColor&&e.css({color:t.contrastColor})});