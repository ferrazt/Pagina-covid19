"use strict";import AST from"../HTML/AST.js";import H from"../../Globals.js";var doc=H.doc,SVG_NS=H.SVG_NS;import U from"../../Utilities.js";var attr=U.attr,isString=U.isString,objectEach=U.objectEach,pick=U.pick,TextBuilder=function(){function t(t){var e=t.styles;this.renderer=t.renderer,this.svgElement=t,this.width=t.textWidth,this.textLineHeight=e&&e.lineHeight,this.textOutline=e&&e.textOutline,this.ellipsis=Boolean(e&&"ellipsis"===e.textOverflow),this.noWrap=Boolean(e&&"nowrap"===e.whiteSpace),this.fontSize=e&&e.fontSize}return t.prototype.buildSVG=function(){var t=this.svgElement,e=t.element,i=t.renderer,n=pick(t.textStr,"").toString(),r=-1!==n.indexOf("<"),s=e.childNodes,o=s.length,l=this.width&&!t.added&&i.box,i=[n,this.ellipsis,this.noWrap,this.textLineHeight,this.textOutline,this.fontSize,this.width].join(",");if(i!==t.textCache){for(t.textCache=i,delete t.actualWidth;o--;)e.removeChild(s[o]);r||this.ellipsis||this.width||-1!==n.indexOf(" ")&&(!this.noWrap||/<br.*?>/g.test(n))?""!==n&&(l&&l.appendChild(e),r=new AST(n),this.modifyTree(r.nodes),r.addToDOM(t.element),this.modifyDOM(),this.ellipsis&&-1!==(e.textContent||"").indexOf("…")&&t.attr("title",this.unescapeEntities(t.textStr||"",["&lt;","&gt;"])),l&&l.removeChild(e)):e.appendChild(doc.createTextNode(this.unescapeEntities(n))),isString(this.textOutline)&&t.applyTextOutline&&t.applyTextOutline(this.textOutline)}},t.prototype.modifyDOM=function(){var c=this,d=this.svgElement,f=attr(d.element,"x");d.firstLineMetrics=void 0,[].forEach.call(d.element.querySelectorAll("tspan.highcharts-br"),function(t,e){t.nextSibling&&t.previousSibling&&(0===e&&1===t.previousSibling.nodeType&&(d.firstLineMetrics=d.renderer.fontMetrics(void 0,t.previousSibling)),attr(t,{dy:c.getLineHeight(t.nextSibling),x:f}))});var i,p=this.width||0;p&&(i=function(e){[].slice.call(e.childNodes).forEach(function(t){t.nodeType===Node.TEXT_NODE?function(e,i){var t=e.textContent||"",n=t.replace(/([^\^])-/g,"$1- ").split(" "),r=!c.noWrap&&(1<n.length||1<d.element.childNodes.length),s=c.getLineHeight(i),o=0,l=d.actualWidth;if(c.ellipsis)t&&c.truncate(e,t,void 0,0,Math.max(0,p-parseInt(c.fontSize||12,10)),function(t,e){return t.substring(0,e)+"…"});else if(r){for(var h=[],a=[];i.firstChild&&i.firstChild!==e;)a.push(i.firstChild),i.removeChild(i.firstChild);for(;n.length;)n.length&&!c.noWrap&&0<o&&(h.push(e.textContent||""),e.textContent=n.join(" ").replace(/- /g,"-")),c.truncate(e,void 0,n,0===o&&l||0,p,function(t,e){return n.slice(0,e).join(" ").replace(/- /g,"-")}),l=d.actualWidth,o++;a.forEach(function(t){i.insertBefore(t,e)}),h.forEach(function(t){i.insertBefore(doc.createTextNode(t),e);t=doc.createElementNS(SVG_NS,"tspan");t.textContent="​",attr(t,{dy:s,x:f}),i.insertBefore(t,e)})}}(t,e):(-1!==t.className.baseVal.indexOf("highcharts-br")&&(d.actualWidth=0),i(t))})})(d.element)},t.prototype.getLineHeight=function(t){var e,t=t.nodeType===Node.TEXT_NODE?t.parentElement:t;return this.renderer.styledMode||(e=t&&/(px|em)$/.test(t.style.fontSize)?t.style.fontSize:this.fontSize||this.renderer.style.fontSize||12),this.textLineHeight?parseInt(this.textLineHeight.toString(),10):this.renderer.fontMetrics(e,t||this.svgElement.element).h},t.prototype.modifyTree=function(s){var o=this,l=function(t,e){var i=t.tagName,n=o.renderer.styledMode,r=t.attributes||{};"b"===i||"strong"===i?n?r.class="highcharts-strong":r.style="font-weight:bold;"+(r.style||""):"i"!==i&&"em"!==i||(n?r.class="highcharts-emphasized":r.style="font-style:italic;"+(r.style||"")),isString(r.style)&&(r.style=r.style.replace(/(;| |^)color([ :])/,"$1fill$2")),"br"===i&&(r.class="highcharts-br",t.textContent="​",(e=s[e+1])&&e.textContent&&(e.textContent=e.textContent.replace(/^ +/gm,""))),"#text"!==i&&"a"!==i&&(t.tagName="tspan"),t.attributes=r,t.children&&t.children.filter(function(t){return"#text"!==t.tagName}).forEach(l)};for(s.forEach(l);s[0]&&"tspan"===s[0].tagName&&!s[0].children;)s.splice(0,1)},t.prototype.truncate=function(n,r,s,o,t,l){function e(t,e){var i=e||t;if((e=n.parentNode)&&void 0===f[i])if(e.getSubStringLength)try{f[i]=o+e.getSubStringLength(0,s?i+1:i)}catch(t){}else c.getSpanWidth&&(n.textContent=l(r||s,t),f[i]=o+c.getSpanWidth(a,n));return f[i]}var i,h,a=this.svgElement,c=a.renderer,d=a.rotation,f=[],p=s?1:0,g=(r||s||"").length,u=g;if(a.rotation=0,h=e(n.textContent.length),t<o+h){for(;p<=g;)h=e(u=Math.ceil((p+g)/2),(i=s?l(s,u):i)&&i.length-1),p===g?p=g+1:t<h?g=u-1:p=u;0===g?n.textContent="":r&&g===r.length-1||(n.textContent=i||l(r||s,u))}s&&s.splice(0,u),a.actualWidth=h,a.rotation=d},t.prototype.unescapeEntities=function(i,n){return objectEach(this.renderer.escapes,function(t,e){n&&-1!==n.indexOf(t)||(i=i.toString().replace(new RegExp(t,"g"),e))}),i},t}();export default TextBuilder;