"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import CenteredSeriesMixin from"../../Mixins/CenteredSeries.js";var getCenter=CenteredSeriesMixin.getCenter,getStartAndEndRadians=CenteredSeriesMixin.getStartAndEndRadians;import H from"../../Core/Globals.js";var noop=H.noop;import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var Series=SeriesRegistry.series,_a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,TreemapSeries=_a.treemap;import SunburstPoint from"./SunburstPoint.js";import SunburstUtilities from"./SunburstUtilities.js";import TreeSeriesMixin from"../../Mixins/TreeSeries.js";var getColor=TreeSeriesMixin.getColor,getLevelOptions=TreeSeriesMixin.getLevelOptions,setTreeValues=TreeSeriesMixin.setTreeValues,updateRootId=TreeSeriesMixin.updateRootId;import U from"../../Core/Utilities.js";var error=U.error,extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,splat=U.splat,rad2deg=180/Math.PI;function isBoolean(e){return"boolean"==typeof e}var getEndPoint=function(e,t,r,i){return{x:e+Math.cos(r)*i,y:t+Math.sin(r)*i}};function getDlOptions(e){var t,r=e.point,i=isObject(e.shapeArgs)?e.shapeArgs:{},o=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},e=splat(isObject(e.level)?e.level.dataLabels:{})[0],e=merge({style:{}},e,o),o=e.rotationMode;return isNumber(e.rotation)||("auto"!==o&&"circular"!==o||(r.innerArcLength<1&&r.outerArcLength>i.radius?(t=0,r.dataLabelPath&&"circular"===o&&(e.textPath={enabled:!0})):1<r.innerArcLength&&r.outerArcLength>1.5*i.radius?"circular"===o?e.textPath={enabled:!0,attributes:{dy:5}}:o="parallel":(r.dataLabel&&r.dataLabel.textPathWrapper&&"circular"===o&&(e.textPath={enabled:!1}),o="perpendicular")),"auto"!==o&&"circular"!==o&&(t=i.end-(i.end-i.start)/2),e.style.width="parallel"===o?Math.min(2.5*i.radius,(r.outerArcLength+r.innerArcLength)/2):i.radius,"perpendicular"===o&&r.series.chart.renderer.fontMetrics(e.style.fontSize).h>r.outerArcLength&&(e.style.width=1),e.style.width=Math.max(e.style.width-2*(e.padding||0),1),t=t*rad2deg%180,"parallel"===o&&(t-=90),90<t?t-=180:t<-90&&(t+=180),e.rotation=t),e.textPath&&(0===r.shapeExisting.innerR&&e.textPath.enabled?(e.rotation=0,e.textPath.enabled=!1,e.style.width=Math.max(2*r.shapeExisting.r-2*(e.padding||0),1)):r.dlOptions&&r.dlOptions.textPath&&!r.dlOptions.textPath.enabled&&"circular"===o&&(e.textPath.enabled=!0),e.textPath.enabled&&(e.rotation=0,e.style.width=Math.max((r.outerArcLength+r.innerArcLength)/2-2*(e.padding||0),1))),0===e.rotation&&(e.rotation=.001),e}function getAnimation(e,t){var r=t.point,i=t.radians,o=t.innerR,n=t.idRoot,a=t.idPreviousRoot,s=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,p=t.visible,u={},t={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return p?!r.graphic&&d&&((u=n===r.id?{start:i.start,end:i.end}:d.end<=e.start?{start:i.end,end:i.end}:{start:i.start,end:i.start}).innerR=u.r=o):r.graphic&&(a===r.id?t={innerR:o,r:o}:l&&(t=l.end<=s.start?{innerR:o,r:o,start:i.end,end:i.end}:{innerR:o,r:o,start:i.start,end:i.start})),{from:u,to:t}}function getDrillId(e,t,r){var i;return i=!e.node.isLeaf?t===e.id?r[t].parent:e.id:i}function cbSetTreeValuesBefore(e,t){var r=t.mapIdToNode[e.parent],i=t.series,o=i.chart,n=i.points[e.i],o=i.options.colors||o&&o.options.colors,r=getColor(e,{colors:o,colorIndex:i.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:r&&r.color,parentColorIndex:r&&r.colorIndex,series:t.series,siblings:t.siblings});return e.color=r.color,e.colorIndex=r.colorIndex,n&&(n.color=e.color,n.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&n.sliced),e}var SunburstSeries=function(i){function e(){var e=null!==i&&i.apply(this,arguments)||this;return e.center=void 0,e.data=void 0,e.mapOptionsToLevel=void 0,e.nodeMap=void 0,e.options=void 0,e.points=void 0,e.shapeRoot=void 0,e.startAndEndRadians=void 0,e.tree=void 0,e}return __extends(e,i),e.prototype.alignDataLabel=function(e,t,r){if(!r.textPath||!r.textPath.enabled)return i.prototype.alignDataLabel.apply(this,arguments)},e.prototype.animate=function(e){var t=this.chart,r=[t.plotWidth/2,t.plotHeight/2],i=t.plotLeft,o=t.plotTop,t=this.group;e?t.attr({translateX:r[0]+i,translateY:r[1]+o,scaleX:.001,scaleY:.001,rotation:10,opacity:.01}):t.animate({translateX:i,translateY:o,scaleX:1,scaleY:1,rotation:0,opacity:1},this.options.animation)},e.prototype.drawPoints=function(){var s,l=this,d=l.mapOptionsToLevel,p=l.shapeRoot,u=l.group,c=l.hasRendered,h=l.rootNode,v=l.idPreviousRoot,g=l.nodeMap,e=g[v],b=e&&e.shapeArgs,t=l.points,f=l.startAndEndRadians,m=l.chart,e=m&&m.options&&m.options.chart||{},x=!isBoolean(e.animation)||e.animation,e=l.center,y={x:e[0],y:e[1]},S=e[3]/2,R=l.chart.renderer,r=!1,A=!1,e=!!(x&&c&&h!==v&&l.dataLabelsGroup);e&&(l.dataLabelsGroup.attr({opacity:0}),s=function(){var e=l;r=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"visible"})}),t.forEach(function(e){var t,r=e.node,i=d[r.level],o=e.shapeExisting||{},n=r.shapeArgs||{},a=!(!r.visible||!r.shapeArgs),o=c&&x?getAnimation(n,{center:y,point:e,radians:f,innerR:S,idRoot:h,idPreviousRoot:v,shapeExisting:o,shapeRoot:p,shapePreviousRoot:b,visible:a}):{to:n,from:{}};extend(e,{shapeExisting:n,tooltipPos:[n.plotX,n.plotY],drillId:getDrillId(e,h,g),name:""+(e.name||e.id||e.index),plotX:n.plotX,plotY:n.plotY,value:r.val,isInside:a,isNull:!a}),e.dlOptions=getDlOptions({point:e,level:i,optionsPoint:e.options,shapeArgs:n}),!A&&a&&(A=!0,t=s),e.draw({animatableAttribs:o.to,attribs:extend(o.from,!m.styledMode&&l.pointAttribs(e,e.selected&&"select")),onComplete:t,group:u,renderer:R,shapeType:"arc",shapeArgs:n})}),e&&A?(l.hasRendered=!1,l.options.dataLabels.defer=!0,Series.prototype.drawDataLabels.call(l),l.hasRendered=!0,r&&s()):Series.prototype.drawDataLabels.call(l)},e.prototype.layoutAlgorithm=function(e,t,r){var o=e.start,n=e.end-o,a=e.val,s=e.x,l=e.y,d=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,p=e.r,u=p+d,c=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce(function(e,t){var r=1/a*t.val*n,i=getEndPoint(s,l,o+r/2,c),r={x:t.sliced?i.x:s,y:t.sliced?i.y:l,innerR:p,r:u,radius:d,start:o,end:o+r};return e.push(r),o=r.end,e},[])},e.prototype.setShapeArgs=function(e,t,a){var r=e.level+1,r=a[r],e=e.children.filter(function(e){return e.visible}),s=this.layoutAlgorithm(t,e,r);e.forEach(function(e,t){var r=s[t],i=r.start+(r.end-r.start)/2,o=r.innerR+(r.r-r.innerR)/2,n=r.end-r.start,t=0===r.innerR&&6.28<n?{x:r.x,y:r.y}:getEndPoint(r.x,r.y,i,o),o=!e.val||e.childrenTotal>e.val?e.childrenTotal:e.val;this.points[e.i]&&(this.points[e.i].innerArcLength=n*r.innerR,this.points[e.i].outerArcLength=n*r.r),e.shapeArgs=merge(r,{plotX:t.x,plotY:t.y+4*Math.abs(Math.cos(i))}),e.values=merge(r,{val:o}),e.children.length&&this.setShapeArgs(e,e.values,a)},this)},e.prototype.translate=function(){var e,t=this,r=t.options,i=t.center=getCenter.call(t),o=t.startAndEndRadians=getStartAndEndRadians(r.startAngle,r.endAngle),n=i[3]/2,a=i[2]/2-n,s=updateRootId(t),l=t.nodeMap,d=l&&l[s],p={};t.shapeRoot=d&&d.shapeArgs,Series.prototype.translate.call(t),e=t.tree=t.getTree(),t.renderTraverseUpButton(s);var d=(l=t.nodeMap)[s],u=l[isString(d.parent)?d.parent:""],c=SunburstUtilities.getLevelFromAndTo(d),h=c.from,v=c.to,c=getLevelOptions({from:h,levels:t.options.levels,to:v,defaults:{colorByPoint:r.colorByPoint,dataLabels:r.dataLabels,levelIsConstant:r.levelIsConstant,levelSize:r.levelSize,slicedOffset:r.slicedOffset}});c=SunburstUtilities.calculateLevelSizes(c,{diffRadius:a,from:h,to:v}),setTreeValues(e,{before:cbSetTreeValuesBefore,idRoot:s,levelIsConstant:r.levelIsConstant,mapOptionsToLevel:c,mapIdToNode:l,points:t.points,series:t}),i=l[""].shapeArgs={end:o.end,r:n,start:o.start,val:d.val,x:i[0],y:i[1]},this.setShapeArgs(u,i,c),t.mapOptionsToLevel=c,t.data.forEach(function(e){p[e.id]&&error(31,!1,t.chart),p[e.id]=!0}),p={}},e.defaultOptions=merge(TreemapSeries.defaultOptions,{center:["50%","50%"],colorByPoint:!1,opacity:1,dataLabels:{allowOverlap:!0,defer:!0,rotationMode:"auto",style:{textOverflow:"ellipsis"}},rootId:void 0,levelIsConstant:!0,levelSize:{value:1,unit:"weight"},slicedOffset:10}),e}(TreemapSeries);extend(SunburstSeries.prototype,{drawDataLabels:noop,pointAttribs:ColumnSeries.prototype.pointAttribs,pointClass:SunburstPoint,utils:SunburstUtilities}),SeriesRegistry.registerSeriesType("sunburst",SunburstSeries);export default SunburstSeries;