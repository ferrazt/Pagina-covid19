"use strict";import Chart from"../../Core/Chart/Chart.js";import Color from"../../Core/Color/Color.js";var color=Color.parse;import F from"../../Core/FormatUtilities.js";import H from"../../Core/Globals.js";var noop=H.noop;import Legend from"../../Core/Legend.js";import D from"../../Core/DefaultOptions.js";var setOptions=D.setOptions;import palette from"../../Core/Color/Palette.js";import Series from"../../Core/Series/Series.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,stableSort=U.stableSort,wrap=U.wrap;import"./BubbleSeries.js";setOptions({legend:{bubbleLegend:{borderColor:void 0,borderWidth:2,className:void 0,color:void 0,connectorClassName:void 0,connectorColor:void 0,connectorDistance:60,connectorWidth:1,enabled:!1,labels:{className:void 0,allowOverlap:!1,format:"",formatter:void 0,align:"right",style:{fontSize:"10px",color:palette.neutralColor100},x:0,y:0},maxSize:60,minSize:10,legendIndex:0,ranges:{value:void 0,borderColor:void 0,color:void 0,connectorColor:void 0},sizeBy:"area",sizeByAbsoluteValue:!1,zIndex:1,zThreshold:0}}});var BubbleLegend=function(){function e(e,t){this.chart=void 0,this.fontMetrics=void 0,this.legend=void 0,this.legendGroup=void 0,this.legendItem=void 0,this.legendItemHeight=void 0,this.legendItemWidth=void 0,this.legendSymbol=void 0,this.maxLabel=void 0,this.movementX=void 0,this.ranges=void 0,this.visible=void 0,this.symbols=void 0,this.options=void 0,this.setState=noop,this.init(e,t)}return e.prototype.init=function(e,t){this.options=e,this.visible=!0,this.chart=t.chart,this.legend=t},e.prototype.addToLegend=function(e){e.splice(this.options.legendIndex,0,this)},e.prototype.drawLegendSymbol=function(e){var t,i=this.chart,s=this.options,o=pick(e.options.itemDistance,20),r=s.ranges,n=s.connectorDistance;this.fontMetrics=i.renderer.fontMetrics(s.labels.style.fontSize),r&&r.length&&isNumber(r[0].value)?(stableSort(r,function(e,t){return t.value-e.value}),this.ranges=r,this.setOptions(),this.render(),t=this.getMaxLabelSize(),r=2*(i=this.ranges[0].radius),i=0<(i=n-i+t.width)?i:0,this.maxLabel=t,this.movementX="left"===s.labels.align?i:0,this.legendItemWidth=r+i+o,this.legendItemHeight=r+this.fontMetrics.h/2):e.options.bubbleLegend.autoRanges=!0},e.prototype.setOptions=function(){var i=this.ranges,s=this.options,o=this.chart.series[s.seriesIndex],r=this.legend.baseline,n={zIndex:s.zIndex,"stroke-width":s.borderWidth},a={zIndex:s.zIndex,"stroke-width":s.connectorWidth},l={align:this.legend.options.rtl||"left"===s.labels.align?"right":"left",zIndex:s.zIndex},d=o.options.marker.fillOpacity,h=this.chart.styledMode;i.forEach(function(e,t){h||(n.stroke=pick(e.borderColor,s.borderColor,o.color),n.fill=pick(e.color,s.color,1!==d?color(o.color).setOpacity(d).get("rgba"):o.color),a.stroke=pick(e.connectorColor,s.connectorColor,o.color)),i[t].radius=this.getRangeRadius(e.value),i[t]=merge(i[t],{center:i[0].radius-i[t].radius+r}),h||merge(!0,i[t],{bubbleAttribs:merge(n),connectorAttribs:merge(a),labelAttribs:l})},this)},e.prototype.getRangeRadius=function(e){var t=this.options,i=this.options.seriesIndex,s=this.chart.series[i],o=t.ranges[0].value,r=t.ranges[t.ranges.length-1].value,i=t.minSize,t=t.maxSize;return s.getRadius.call(this,r,o,i,t,e)},e.prototype.render=function(){var e=this.chart.renderer,t=this.options.zThreshold;this.symbols||(this.symbols={connectors:[],bubbleItems:[],labels:[]}),this.legendSymbol=e.g("bubble-legend"),this.legendItem=e.g("bubble-legend-item"),this.legendSymbol.translateX=0,this.legendSymbol.translateY=0,this.ranges.forEach(function(e){e.value>=t&&this.renderRange(e)},this),this.legendSymbol.add(this.legendItem),this.legendItem.add(this.legendGroup),this.hideOverlappingLabels()},e.prototype.renderRange=function(e){var t=this.ranges[0],i=this.legend,s=this.options,o=s.labels,r=this.chart,n=r.series[s.seriesIndex],a=r.renderer,l=this.symbols,d=l.labels,h=e.center,b=Math.abs(e.radius),g=s.connectorDistance||0,c=o.align,p=i.options.rtl||"left"===c?-g:g,u=s.borderWidth,m=s.connectorWidth,r=t.radius||0,i=h-b-u/2+m/2,g=this.fontMetrics,t=g.f/2-(g.h-g.f)/2,u=(i%1?1:.5)-(m%2?0:.5),g=a.styledMode;"center"===c&&(s.connectorDistance=p=0,e.labelAttribs.align="center"),m=i+s.labels.y,c=r+p+s.labels.x,l.bubbleItems.push(a.circle(r,h+u,b).attr(g?{}:e.bubbleAttribs).addClass((g?"highcharts-color-"+n.colorIndex+" ":"")+"highcharts-bubble-legend-symbol "+(s.className||"")).add(this.legendSymbol)),l.connectors.push(a.path(a.crispLine([["M",r,i],["L",r+p,i]],s.connectorWidth)).attr(g?{}:e.connectorAttribs).addClass((g?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-connectors "+(s.connectorClassName||"")).add(this.legendSymbol)),s=a.text(this.formatLabel(e),c,m+t).attr(g?{}:e.labelAttribs).css(g?{}:o.style).addClass("highcharts-bubble-legend-labels "+(s.labels.className||"")).add(this.legendSymbol),d.push(s),s.placed=!0,s.alignAttr={x:c,y:m+t}},e.prototype.getMaxLabelSize=function(){var t,i;return this.symbols.labels.forEach(function(e){i=e.getBBox(!0),t=!t||i.width>t.width?i:t}),t||{}},e.prototype.formatLabel=function(e){var t=this.options,i=t.labels.formatter,s=t.labels.format,t=this.chart.numberFormatter;return s?F.format(s,e):i?i.call(e):t(e.value,1)},e.prototype.hideOverlappingLabels=function(){var e=this.chart,t=this.options.labels.allowOverlap,i=this.symbols;!t&&i&&(e.hideOverlappingLabels(i.labels),i.labels.forEach(function(e,t){e.newOpacity?e.newOpacity!==e.oldOpacity&&i.connectors[t].show():i.connectors[t].hide()}))},e.prototype.getRanges=function(){var i,t,e=this.legend.bubbleLegend,s=e.chart.series,o=e.options.ranges,r=Number.MAX_VALUE,n=-Number.MAX_VALUE;return s.forEach(function(e){e.isBubble&&!e.ignoreSeries&&(t=e.zData.filter(isNumber)).length&&(r=pick(e.options.zMin,Math.min(r,Math.max(arrayMin(t),!1===e.options.displayNegative?e.options.zThreshold:-Number.MAX_VALUE))),n=pick(e.options.zMax,Math.max(n,arrayMax(t))))}),i=r===n?[{value:n}]:[{value:r},{value:(r+n)/2},{value:n,autoRanges:!0}],o.length&&o[0].radius&&i.reverse(),i.forEach(function(e,t){o&&o[t]&&(i[t]=merge(o[t],e))}),i},e.prototype.predictBubbleSizes=function(){var e,t=this.chart,i=this.fontMetrics,s=t.legend.options,o=s.floating,r="horizontal"===s.layout,n=r?t.legend.lastLineHeight:0,a=t.plotSizeX,l=t.plotSizeY,d=t.series[this.options.seriesIndex],h=Math.ceil(d.minPxSize),s=Math.ceil(d.maxPxSize),t=d.options.maxSize,d=Math.min(l,a);return o||!/%$/.test(t)?e=s:(t=parseFloat(t),e=(d+n-i.h/2)*t/100/(t/100+1),(r&&a<=l-e||!r&&l<=a-e)&&(e=s)),[h,Math.ceil(e)]},e.prototype.updateRanges=function(e,t){var i=this.legend.options.bubbleLegend;i.minSize=e,i.maxSize=t,i.ranges=this.getRanges()},e.prototype.correctSizes=function(){var e=this.legend,t=this.chart.series[this.options.seriesIndex],i=t.maxPxSize,s=this.options.maxSize;1<Math.abs(Math.ceil(i)-s)&&(this.updateRanges(this.options.minSize,t.maxPxSize),e.render())},e}();addEvent(Legend,"afterGetAllItems",function(e){var t=this,i=t.bubbleLegend,s=t.options,o=s.bubbleLegend,r=t.chart.getVisibleBubbleSeriesIndex();i&&i.ranges&&i.ranges.length&&(o.ranges.length&&(o.autoRanges=!!o.ranges[0].autoRanges),t.destroyItem(i)),0<=r&&s.enabled&&o.enabled&&(o.seriesIndex=r,t.bubbleLegend=new H.BubbleLegend(o,t),t.bubbleLegend.addToLegend(e.allItems))}),Chart.prototype.getVisibleBubbleSeriesIndex=function(){for(var e=this.series,t=0;t<e.length;){if(e[t]&&e[t].isBubble&&e[t].visible&&e[t].zData.length)return t;t++}return-1},Legend.prototype.getLinesHeights=function(){for(var e,t=this.allItems,i=[],s=t.length,o=0,r=0,o=0;o<s;o++)if(t[o].legendItemHeight&&(t[o].itemHeight=t[o].legendItemHeight),t[o]===t[s-1]||t[o+1]&&t[o]._legendItemPos[1]!==t[o+1]._legendItemPos[1]){for(i.push({height:0}),e=i[i.length-1];r<=o;r++)t[r].itemHeight>e.height&&(e.height=t[r].itemHeight);e.step=o}return i},Legend.prototype.retranslateItems=function(i){var s,o,r,e=this.allItems,n=this.options.rtl,a=0;e.forEach(function(e,t){s=e.legendGroup.translateX,o=e._legendItemPos[1],((r=e.movementX)||n&&e.ranges)&&(r=n?s-e.options.maxSize/2:s+r,e.legendGroup.attr({translateX:r})),t>i[a].step&&a++,e.legendGroup.attr({translateY:Math.round(o+i[a].height/2)}),e._legendItemPos[1]=o+i[a].height/2})},addEvent(Series,"legendItemClick",function(){var e=this,t=e.chart,i=e.visible,s=e.chart.legend;s&&s.bubbleLegend&&(e.visible=!i,e.ignoreSeries=i,t=0<=t.getVisibleBubbleSeriesIndex(),s.bubbleLegend.visible!==t&&(s.update({bubbleLegend:{enabled:t}}),s.bubbleLegend.visible=t),e.visible=i)}),wrap(Chart.prototype,"drawChartBox",function(e,t,i){var s,o=this,r=o.legend,n=0<=o.getVisibleBubbleSeriesIndex();r&&r.options.enabled&&r.bubbleLegend&&r.options.bubbleLegend.autoRanges&&n?(s=r.bubbleLegend.options,n=r.bubbleLegend.predictBubbleSizes(),r.bubbleLegend.updateRanges(n[0],n[1]),s.placed||(r.group.placed=!1,r.allItems.forEach(function(e){e.legendGroup.translateY=null})),r.render(),o.getMargins(),o.axes.forEach(function(e){e.visible&&e.render(),s.placed||(e.setScale(),e.updateNames(),objectEach(e.ticks,function(e){e.isNew=!0,e.isNewLabel=!0}))}),s.placed=!0,o.getMargins(),e.call(o,t,i),r.bubbleLegend.correctSizes(),r.retranslateItems(r.getLinesHeights())):(e.call(o,t,i),r&&r.options.enabled&&r.bubbleLegend&&(r.render(),r.retranslateItems(r.getLinesHeights())))}),H.BubbleLegend=BubbleLegend;export default H.BubbleLegend;