"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};return function(t,e){function a(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}}();import Axis from"../../Core/Axis/Axis.js";import Chart from"../../Core/Chart/Chart.js";import palette from"../../Core/Color/Palette.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,LineSeries=_a.line;import U from"../../Core/Utilities.js";var arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,extend=U.extend,merge=U.merge,objectEach=U.objectEach,pick=U.pick;import WaterfallAxis from"../../Core/Axis/WaterfallAxis.js";import WaterfallPoint from"./WaterfallPoint.js";import"../../Core/DefaultOptions.js";function ownProp(t,e){return Object.hasOwnProperty.call(t,e)}var WaterfallSeries=function(y){function t(){var t=null!==y&&y.apply(this,arguments)||this;return t.chart=void 0,t.data=void 0,t.options=void 0,t.points=void 0,t.stackedYNeg=void 0,t.stackedYPos=void 0,t.stackKey=void 0,t.xData=void 0,t.yAxis=void 0,t.yData=void 0,t}return __extends(t,y),t.prototype.generatePoints=function(){var t,e,a,o;for(ColumnSeries.prototype.generatePoints.apply(this),a=0,e=this.points.length;a<e;a++)t=this.points[a],o=this.processedYData[a],(t.isIntermediateSum||t.isSum)&&(t.y=correctFloat(o))},t.prototype.translate=function(){var t,e,a,o,r,s,i,n,l,h,p,d,c,u,y,g=this,f=g.options,m=g.yAxis,S=pick(f.minPointLength,5),x=S/2,k=f.threshold,P=f.stacking,v=m.waterfall.stacks[g.stackKey];for(ColumnSeries.prototype.translate.apply(g),i=n=k,e=0,t=(a=g.points).length;e<t;e++)o=a[e],s=g.processedYData[e],h=o.shapeArgs,l=[0,s],c=o.y,P?v&&(p=v[e],"overlap"===P?(d=p.stackState[p.stateIndex--],r=0<=c?d:d-c,ownProp(p,"absolutePos")&&delete p.absolutePos,ownProp(p,"absoluteNeg")&&delete p.absoluteNeg):(r=0<=c?(d=p.threshold+p.posTotal,p.posTotal-=c,d):(d=p.threshold+p.negTotal,p.negTotal-=c,d-c),p.posTotal||ownProp(p,"absolutePos")&&(p.posTotal=p.absolutePos,delete p.absolutePos),p.negTotal||ownProp(p,"absoluteNeg")&&(p.negTotal=p.absoluteNeg,delete p.absoluteNeg)),o.isSum||(p.connectorThreshold=p.threshold+p.stackTotal),y=m.reversed?(u=0<=c?r-c:r+c,r):(u=r)-c,o.below=u<=pick(k,0),h.y=m.translate(u,0,1,0,1),h.height=Math.abs(h.y-m.translate(y,0,1,0,1)),(p=m.waterfall.dummyStackItem)&&(p.x=e,p.label=v[e].label,p.setOffset(g.pointXOffset||0,g.barW||0,g.stackedYNeg[e],g.stackedYPos[e]))):(r=Math.max(i,i+c)+l[0],h.y=m.translate(r,0,1,0,1),o.isSum?(h.y=m.translate(l[1],0,1,0,1),h.height=Math.min(m.translate(l[0],0,1,0,1),m.len)-h.y):o.isIntermediateSum?(y=0<=c?(u=l[1]+n,n):(u=n,l[1]+n),m.reversed&&(u^=y,u^=y^=u),h.y=m.translate(u,0,1,0,1),h.height=Math.abs(h.y-Math.min(m.translate(y,0,1,0,1),m.len)),n+=l[1]):(h.height=0<s?m.translate(i,0,1,0,1)-h.y:m.translate(i,0,1,0,1)-m.translate(i-s,0,1,0,1),o.below=(i+=s)<pick(k,0)),h.height<0&&(h.y+=h.height,h.height*=-1)),o.plotY=h.y=Math.round(h.y)-g.borderWidth%2/2,h.height=Math.max(Math.round(h.height),.001),o.yBottom=h.y+h.height,h.height<=S&&!o.isNull?(h.height=S,h.y-=x,o.plotY=h.y,o.y<0?o.minPointLengthOffset=-x:o.minPointLengthOffset=x):(o.isNull&&(h.width=0),o.minPointLengthOffset=0),h=o.plotY+(o.negative?h.height:0),g.chart.inverted?o.tooltipPos[0]=m.len-h:o.tooltipPos[1]=h},t.prototype.processData=function(t){for(var e,a,o,r,s,i=this,n=i.options,l=i.yData,h=n.data,p=l.length,d=n.threshold||0,c=a=o=r=0,u=0;u<p;u++)s=l[u],e=h&&h[u]?h[u]:{},"sum"===s||e.isSum?l[u]=correctFloat(c):"intermediateSum"===s||e.isIntermediateSum?(l[u]=correctFloat(a),a=0):(c+=s,a+=s),o=Math.min(c,o),r=Math.max(c,r);y.prototype.processData.call(this,t),n.stacking||(i.dataMin=o+d,i.dataMax=r)},t.prototype.toYData=function(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y},t.prototype.updateParallelArrays=function(t,e){y.prototype.updateParallelArrays.call(this,t,e),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)},t.prototype.pointAttribs=function(t,e){var a=this.options.upColor;return a&&!t.options.color&&(t.color=0<t.y?a:null),delete(e=ColumnSeries.prototype.pointAttribs.call(this,t,e)).dashstyle,e},t.prototype.getGraphPath=function(){return[["M",0,0]]},t.prototype.getCrispPath=function(){for(var t=this.data,e=this.yAxis,a=t.length,o=Math.round(this.graph.strokeWidth())%2/2,r=Math.round(this.borderWidth)%2/2,s=this.xAxis.reversed,i=this.yAxis.reversed,n=this.options.stacking,l=[],h=1;h<a;h++){var p=t[h].shapeArgs,d=t[h-1],c=t[h-1].shapeArgs,u=e.waterfall.stacks[this.stackKey],y=0<d.y?-c.height:0;u&&c&&p&&(u=u[h-1],y=n?(u=u.connectorThreshold,Math.round(e.translate(u,0,1,0,1)+(i?y:0))-o):c.y+d.minPointLengthOffset+r-o,l.push(["M",(c.x||0)+(!s&&c.width||0),y],["L",(p.x||0)+(s&&p.width||0),y])),c&&l.length&&(!n&&d.y<0&&!i||0<d.y&&i)&&((d=l[l.length-2])&&"number"==typeof d[2]&&(d[2]+=c.height||0),(d=l[l.length-1])&&"number"==typeof d[2]&&(d[2]+=c.height||0))}return l},t.prototype.drawGraph=function(){LineSeries.prototype.drawGraph.call(this),this.graph.attr({d:this.getCrispPath()})},t.prototype.setStackedPoints=function(){var r,t,e,a,s,o,i,n,l,h,p,d=this,c=d.options,u=d.yAxis.waterfall.stacks,y=c.threshold,g=y||0,f=g,m=d.stackKey,S=d.xData,x=S.length;function k(t,e,a,o){if(s)for(;a<s;a++)r.stackState[a]+=o;else r.stackState[0]=t,s=r.stackState.length;r.stackState.push(r.stackState[s-1]+e)}if(d.yAxis.stacking.usePercentage=!1,t=e=a=g,d.visible||!d.chart.options.chart.ignoreHiddenSeries){p=u.changed,(h=u.alreadyChanged)&&h.indexOf(m)<0&&(p=!0),u[m]||(u[m]={});for(var P=u[m],v=0;v<x;v++)P[l=S[v]]&&!p||(P[l]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:p&&P[l]?P[l].label:void 0}),r=P[l],0<=(n=d.yData[v])?r.posTotal+=n:r.negTotal+=n,i=c.data[v],o=r.absolutePos=r.posTotal,l=r.absoluteNeg=r.negTotal,r.stackTotal=o+l,s=r.stackState.length,i&&i.isIntermediateSum?(k(a,e,0,a),a=e,e=y,g^=f,g^=f^=g):i&&i.isSum?(k(y,t,s),g=y):(k(g,n,0,t),i&&(t+=n,e+=n)),r.stateIndex++,r.threshold=g,g+=r.stackTotal;u.changed=!1,u.alreadyChanged||(u.alreadyChanged=[]),u.alreadyChanged.push(m)}},t.prototype.getExtremes=function(){var t,e,a,o=this.options.stacking;return o?(t=this.yAxis.waterfall.stacks,e=this.stackedYNeg=[],a=this.stackedYPos=[],objectEach(t[this.stackKey],"overlap"===o?function(t){e.push(arrayMin(t.stackState)),a.push(arrayMax(t.stackState))}:function(t){e.push(t.negTotal+t.threshold),a.push(t.posTotal+t.threshold)}),{dataMin:arrayMin(e),dataMax:arrayMax(a)}):{dataMin:this.dataMin,dataMax:this.dataMax}},t.defaultOptions=merge(ColumnSeries.defaultOptions,{dataLabels:{inside:!0},lineWidth:1,lineColor:palette.neutralColor80,dashStyle:"Dot",borderColor:palette.neutralColor80,states:{hover:{lineWidthPlus:0}}}),t}(ColumnSeries);extend(WaterfallSeries.prototype,{getZonesGraphs:LineSeries.prototype.getZonesGraphs,pointValKey:"y",showLine:!0,pointClass:WaterfallPoint}),SeriesRegistry.registerSeriesType("waterfall",WaterfallSeries),WaterfallAxis.compose(Axis,Chart);export default WaterfallSeries;