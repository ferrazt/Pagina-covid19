"use strict";import Axis from"../Core/Axis/Axis.js";import DateTimeAxis from"../Core/Axis/DateTimeAxis.js";import F from"../Core/FormatUtilities.js";var format=F.format;import H from"../Core/Globals.js";import Point from"../Core/Series/Point.js";import Series from"../Core/Series/Series.js";var seriesProto=Series.prototype;import Tooltip from"../Core/Tooltip.js";import D from"../Core/DefaultOptions.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,defined=U.defined,error=U.error,extend=U.extend,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../Core/Axis/Axis.js";var approximations=H.approximations={sum:function(t){var o,a=t.length;if(!a&&t.hasNulls)o=null;else if(a)for(o=0;a--;)o+=t[a];return o},average:function(t){var o=t.length,t=approximations.sum(t);return t=isNumber(t)&&o?correctFloat(t/o):t},averages:function(){var o=[];return[].forEach.call(arguments,function(t){o.push(approximations.average(t))}),void 0===o[0]?void 0:o},open:function(t){return t.length?t[0]:t.hasNulls?null:void 0},high:function(t){return t.length?arrayMax(t):t.hasNulls?null:void 0},low:function(t){return t.length?arrayMin(t):t.hasNulls?null:void 0},close:function(t){return t.length?t[t.length-1]:t.hasNulls?null:void 0},ohlc:function(t,o,a,e){if(t=approximations.open(t),o=approximations.high(o),a=approximations.low(a),e=approximations.close(e),isNumber(t)||isNumber(o)||isNumber(a)||isNumber(e))return[t,o,a,e]},range:function(t,o){return t=approximations.low(t),o=approximations.high(o),isNumber(t)||isNumber(o)?[t,o]:null===t&&null===o?null:void 0}},groupData=function(t,o,a,e){var i,r,n,s,p,u,l=this,d=l.data,h=l.options&&l.options.data,m=[],g=[],c=[],f=t.length,x=!!o,D=[],G=l.pointArrayMap,b=G&&G.length,M=["x"].concat(G||["y"]),v=this.options.dataGrouping&&this.options.dataGrouping.groupAll,P=0,A=0;for(n="function"==typeof(u=e)?u:approximations[u]||approximations[l.getDGApproximation&&l.getDGApproximation()||"average"],b?G.forEach(function(){D.push([])}):D.push([]),s=b||1,p=0;p<=f&&!(t[p]>=a[0]);p++);for(;p<=f;p++){for(;void 0!==a[P+1]&&t[p]>=a[P+1]||p===f;){for(i=a[P],l.dataGroupInfo={start:v?A:l.cropStart+A,length:D[0].length},r=n.apply(l,D),l.pointClass&&!defined(l.dataGroupInfo.options)&&(l.dataGroupInfo.options=merge(l.pointClass.prototype.optionsToObject.call({series:l},l.options.data[l.cropStart+A])),M.forEach(function(t){delete l.dataGroupInfo.options[t]})),void 0!==r&&(m.push(i),g.push(r),c.push(l.dataGroupInfo)),A=p,k=0;k<s;k++)D[k].length=0,D[k].hasNulls=!1;if(P+=1,p===f)break}if(p===f)break;if(G)for(var y,S=l.options.dataGrouping&&l.options.dataGrouping.groupAll?p:l.cropStart+p,N=d&&d[S]||l.pointClass.prototype.applyOptions.apply({series:l},[h[S]]),k=0;k<b;k++)y=N[G[k]],isNumber(y)?D[k].push(y):null===y&&(D[k].hasNulls=!0);else S=x?o[p]:null,isNumber(S)?D[0].push(S):null===S&&(D[0].hasNulls=!0)}return{groupedXData:m,groupedYData:g,groupMap:c}},anchorPoints=function(t,o,a){var e=t.options.dataGrouping,i=t.currentDataGrouping&&t.currentDataGrouping.gapSize;if(e&&t.xData&&i&&t.groupMap){var r,n=o.length-1,s=e.anchor,p=pick(e.firstAnchor,s),u=pick(e.lastAnchor,s);if(s&&"start"!==s)for(var l=i*{middle:.5,end:1}[s],d=o.length-1;d--&&0<d;)o[d]+=l;p&&"start"!==p&&t.xData[0]>=o[0]&&(r=t.groupMap[0].start,e=t.groupMap[0].length,s=void 0,isNumber(r)&&isNumber(e)&&(s=r+(e-1)),o[0]={middle:o[0]+.5*i,end:o[0]+i,firstPoint:t.xData[0],lastPoint:s&&t.xData[s]}[p]),u&&"start"!==u&&i&&o[n]>=a-i&&(a=t.groupMap[t.groupMap.length-1].start,o[n]={middle:o[n]+.5*i,end:o[n]+i,firstPoint:a&&t.xData[a],lastPoint:t.xData[t.xData.length-1]}[u])}},adjustExtremes=function(t,o){defined(o[0])&&isNumber(t.min)&&isNumber(t.dataMin)&&o[0]<t.min&&((!defined(t.options.min)&&t.min<=t.dataMin||t.min===t.dataMin)&&(t.min=Math.min(o[0],t.min)),t.dataMin=Math.min(o[0],t.dataMin)),defined(o[o.length-1])&&isNumber(t.max)&&isNumber(t.dataMax)&&o[o.length-1]>t.max&&((!defined(t.options.max)&&isNumber(t.dataMax)&&t.max>=t.dataMax||t.max===t.dataMax)&&(t.max=Math.max(o[o.length-1],t.max)),t.dataMax=Math.max(o[o.length-1],t.dataMax))},dataGrouping={approximations:approximations,groupData:groupData},baseProcessData=seriesProto.processData,baseGeneratePoints=seriesProto.generatePoints,commonOptions={groupPixelWidth:2,dateTimeLabelFormats:{millisecond:["%A, %b %e, %H:%M:%S.%L","%A, %b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%A, %b %e, %H:%M:%S","%A, %b %e, %H:%M:%S","-%H:%M:%S"],minute:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],hour:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],day:["%A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],week:["Week from %A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}},specificOptions={line:{},spline:{},area:{},areaspline:{},arearange:{},column:{groupPixelWidth:10},columnrange:{groupPixelWidth:10},candlestick:{groupPixelWidth:10},ohlc:{groupPixelWidth:5}},defaultDataGroupingUnits=H.defaultDataGroupingUnits=[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1]],["week",[1]],["month",[1,3,6]],["year",null]];seriesProto.getDGApproximation=function(){return this.is("arearange")?"range":this.is("ohlc")?"ohlc":this.is("column")?"sum":"average"},seriesProto.groupData=groupData,seriesProto.processData=function(){var t,o=this,a=o.chart,e=o.options.dataGrouping,i=!1!==o.allowDG&&e&&pick(e.enabled,a.options.isStock),r=o.visible||!a.options.chart.ignoreHiddenSeries,n=this.currentDataGrouping,s=!1;if(o.forceCrop=i,o.groupPixelWidth=null,o.hasProcessed=!0,i&&!o.requireSorting&&(o.requireSorting=s=!0),g=!1===baseProcessData.apply(o,arguments)||!i,s&&(o.requireSorting=!1),!g){o.destroyGroupedData();var p=void 0,u=e.groupAll?o.xData:o.processedXData,l=e.groupAll?o.yData:o.processedYData,d=a.plotSizeX,h=o.xAxis,i=h.options.ordinal,s=o.groupPixelWidth=h.getGroupPixelWidth&&h.getGroupPixelWidth();if(s&&u&&u.length){o.isDirty=t=!0,o.points=null;var m=h.getExtremes(),g=m.min,m=m.max,i=s*(m-g)/d*(i&&h.ordinal&&h.ordinal.getGroupIntervalFactor(g,m,o)||1),c=h.getTimeTicks(DateTimeAxis.AdditionsClass.prototype.normalizeTimeTickInterval(i,e.units||defaultDataGroupingUnits),Math.min(g,u[0]),Math.max(m,u[u.length-1]),h.options.startOfWeek,u,o.closestPointRange),g=seriesProto.groupData.apply(o,[u,l,c,e.approximation]),u=g.groupedXData,l=g.groupedYData,f=0;for(e&&e.smoothed&&u.length&&(e.firstAnchor="firstPoint",e.anchor="middle",e.lastAnchor="lastPoint",error(32,!1,a,{"dataGrouping.smoothed":"use dataGrouping.anchor"})),anchorPoints(o,u,m),p=1;p<c.length;p++)c.info.segmentStarts&&-1!==c.info.segmentStarts.indexOf(p)||(f=Math.max(c[p]-c[p-1],f));(m=c.info).gapSize=f,o.closestPointRange=c.info.totalRange,o.groupMap=g.groupMap,r&&adjustExtremes(h,u),e.groupAll&&(u=(h=o.cropData(u,l,h.min,h.max,1)).xData,l=h.yData,o.cropStart=h.start),o.processedXData=u,o.processedYData=l}else o.groupMap=null;o.hasGroupedData=t,o.currentDataGrouping=m,o.preventGraphAnimation=(n&&n.totalRange)!==(m&&m.totalRange)}},seriesProto.destroyGroupedData=function(){this.groupedData&&(this.groupedData.forEach(function(t,o){t&&(this.groupedData[o]=t.destroy?t.destroy():null)},this),this.groupedData.length=0)},seriesProto.generatePoints=function(){baseGeneratePoints.apply(this),this.destroyGroupedData(),this.groupedData=this.hasGroupedData?this.points:null},addEvent(Point,"update",function(){if(this.dataGroup)return error(24,!1,this.series.chart),!1}),addEvent(Tooltip,"headerFormatter",function(t){var o,a,e=this.chart,i=e.time,r=t.labelConfig,n=r.series,s=n.options,p=n.tooltipOptions,u=s.dataGrouping,l=p.xDateFormat,d=n.xAxis,h=p[(t.isFooter?"footer":"header")+"Format"];d&&"datetime"===d.options.type&&u&&isNumber(r.key)&&(a=n.currentDataGrouping,s=u.dateTimeLabelFormats||commonOptions.dateTimeLabelFormats,a?(u=s[a.unitName],1===a.count?l=u[0]:(l=u[1],o=u[2])):!l&&s&&(l=this.getXDateFormat(r,p,d)),l=i.dateFormat(l,r.key),o&&(l+=i.dateFormat(o,r.key+a.totalRange-1)),n.chart.styledMode&&(h=this.styledModeFormat(h)),t.text=format(h,{point:extend(r.point,{key:l}),series:n},e),t.preventDefault())}),addEvent(Series,"destroy",seriesProto.destroyGroupedData),addEvent(Series,"afterSetOptions",function(t){var o=t.options,a=this.type,e=this.chart.options.plotOptions,i=D.defaultOptions.plotOptions[a].dataGrouping,r=this.useCommonDataGrouping&&commonOptions;(specificOptions[a]||r)&&(i=i||merge(commonOptions,specificOptions[a]),t=this.chart.rangeSelector,o.dataGrouping=merge(r,i,e.series&&e.series.dataGrouping,e[a].dataGrouping,this.userOptions.dataGrouping,!o.isInternal&&t&&isNumber(t.selected)&&t.buttonOptions[t.selected].dataGrouping))}),addEvent(Axis,"afterSetScale",function(){this.series.forEach(function(t){t.hasProcessed=!1})}),Axis.prototype.getGroupPixelWidth=function(){for(var t,o,a=this.series,e=a.length,i=0,r=!1,n=e;n--;)(o=a[n].options.dataGrouping)&&(i=Math.max(i,pick(o.groupPixelWidth,commonOptions.groupPixelWidth)));for(n=e;n--;)(o=a[n].options.dataGrouping)&&a[n].hasProcessed&&(t=(a[n].processedXData||a[n].data).length,(a[n].groupPixelWidth||t>this.chart.plotSizeX/i||t&&o.forced)&&(r=!0));return r?i:0},Axis.prototype.setDataGrouping=function(o,t){var a;if(t=pick(t,!0),o=o||{forced:!1,units:null},this instanceof Axis)for(a=this.series.length;a--;)this.series[a].update({dataGrouping:o},!1);else this.chart.options.series.forEach(function(t){t.dataGrouping=o},!1);this.ordinal&&(this.ordinal.slope=void 0),t&&this.chart.redraw()};export default H.dataGrouping=dataGrouping;