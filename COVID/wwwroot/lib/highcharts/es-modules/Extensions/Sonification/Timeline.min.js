"use strict";import H from"../../Core/Globals.js";import U from"../../Core/Utilities.js";var merge=U.merge,splat=U.splat,uniqueKey=U.uniqueKey;import utilities from"./Utilities.js";function TimelineEvent(t){this.init(t||{})}function TimelinePath(t){this.init(t)}function Timeline(t){this.init(t||{})}TimelineEvent.prototype.init=function(t){this.options=t,this.time=t.time||0,this.id=this.options.id=t.id||uniqueKey()},TimelineEvent.prototype.play=function(t){var n=this.options.eventObject,i=this.options.onEnd,e=t&&t.onEnd,s=this.options.playOptions&&this.options.playOptions.onEnd,t=merge(this.options.playOptions,t);n&&n.sonify?(t.onEnd=i||e||s?function(){var n=arguments;[i,e,s].forEach(function(t){t&&t.apply(this,n)})}:void 0,n.sonify(t)):(e&&e(),i&&i())},TimelineEvent.prototype.cancel=function(t){this.options.eventObject.cancelSonify(t)},TimelinePath.prototype.init=function(t){this.options=t,this.id=this.options.id=t.id||uniqueKey(),this.cursor=0,this.eventsPlaying={},this.events=t.silentWait?[new TimelineEvent({time:0}),new TimelineEvent({time:t.silentWait})]:this.options.events,this.targetDuration=t.targetDuration||t.silentWait,this.sortEvents(),this.updateEventIdMap(),this.signalHandler=new utilities.SignalHandler(["playOnEnd","masterOnEnd","onStart","onEventStart","onEventEnd"]),this.signalHandler.registerSignalCallbacks(merge(t,{masterOnEnd:t.onEnd}))},TimelinePath.prototype.sortEvents=function(){this.events=this.events.sort(function(t,n){return t.time-n.time})},TimelinePath.prototype.updateEventIdMap=function(){this.eventIdMap=this.events.reduce(function(t,n,i){return t[n.id]=i,t},{})},TimelinePath.prototype.addTimelineEvents=function(t){this.events=this.events.concat(t),this.sortEvents(),this.updateEventIdMap()},TimelinePath.prototype.getCursor=function(){return this.events[this.cursor]},TimelinePath.prototype.setCursor=function(t){t=this.eventIdMap[t];return void 0!==t&&(this.cursor=t,!0)},TimelinePath.prototype.play=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(1)},TimelinePath.prototype.rewind=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(-1)},TimelinePath.prototype.resetCursor=function(){this.cursor=0},TimelinePath.prototype.resetCursorEnd=function(){this.cursor=this.events.length-1},TimelinePath.prototype.pause=function(n){var i=this;clearTimeout(i.nextScheduledPlay),Object.keys(i.eventsPlaying).forEach(function(t){i.eventsPlaying[t]&&i.eventsPlaying[t].cancel(n)}),i.eventsPlaying={}},TimelinePath.prototype.playEvents=function(t){function n(t){e.signalHandler.emitSignal("masterOnEnd",t),e.signalHandler.emitSignal("playOnEnd",t)}var i,e=this,s=e.events[this.cursor],a=e.events[this.cursor+t];!1!==(s.timelinePath=e).signalHandler.emitSignal("onEventStart",s)?((e.eventsPlaying[s.id]=s).play({onEnd:function(t){t={event:s,cancelled:!!t};delete e.eventsPlaying[s.id],e.signalHandler.emitSignal("onEventEnd",t),a||n(t)}}),a&&((i=Math.abs(a.time-s.time))<1?(e.cursor+=t,e.playEvents(t)):this.nextScheduledPlay=setTimeout(function(){e.cursor+=t,e.playEvents(t)},i))):n({event:s,cancelled:!0})},Timeline.prototype.init=function(t){this.options=t,this.cursor=0,this.paths=t.paths||[],this.pathsPlaying={},this.signalHandler=new utilities.SignalHandler(["playOnEnd","masterOnEnd","onPathStart","onPathEnd"]),this.signalHandler.registerSignalCallbacks(merge(t,{masterOnEnd:t.onEnd}))},Timeline.prototype.play=function(t){this.pause(),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playPaths(1)},Timeline.prototype.rewind=function(t){this.pause(),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playPaths(-1)},Timeline.prototype.playPaths=function(e){var s=this,a=s.signalHandler;if(!s.paths.length){var t={cancelled:!1};return a.emitSignal("playOnEnd",t),void a.emitSignal("masterOnEnd",t)}var r=splat(this.paths[this.cursor]),l=this.paths[this.cursor+e],o=0;r.forEach(function(t){t&&(t.timeline=s,setTimeout(function(){var i;i=t,a.emitSignal("onPathStart",i),(s.pathsPlaying[i.id]=i)[0<e?"play":"rewind"](function(t){var n=t&&t.cancelled,t={path:i,cancelled:n};delete s.pathsPlaying[i.id],a.emitSignal("onPathEnd",t),++o>=r.length&&(l&&!n?(s.cursor+=e,splat(l).forEach(function(t){t[0<e?"resetCursor":"resetCursorEnd"]()}),s.playPaths(e)):(a.emitSignal("playOnEnd",t),a.emitSignal("masterOnEnd",t)))})},H.sonification.fadeOutDuration))})},Timeline.prototype.pause=function(n){var i=this;Object.keys(i.pathsPlaying).forEach(function(t){i.pathsPlaying[t]&&i.pathsPlaying[t].pause(n)}),i.pathsPlaying={}},Timeline.prototype.resetCursor=function(){this.paths.forEach(function(t){splat(t).forEach(function(t){t.resetCursor()})}),this.cursor=0},Timeline.prototype.resetCursorEnd=function(){this.paths.forEach(function(t){splat(t).forEach(function(t){t.resetCursorEnd()})}),this.cursor=this.paths.length-1},Timeline.prototype.setCursor=function(n){return this.paths.some(function(t){return splat(t).some(function(t){return t.setCursor(n)})})},Timeline.prototype.getCursor=function(){return this.getCurrentPlayingPaths().reduce(function(t,n){return t[n.id]=n.getCursor(),t},{})},Timeline.prototype.atStart=function(){return!this.cursor&&!splat(this.paths[0]).some(function(t){return t.cursor})},Timeline.prototype.getCurrentPlayingPaths=function(){return this.paths.length?splat(this.paths[this.cursor]):[]};var timelineClasses={TimelineEvent:TimelineEvent,TimelinePath:TimelinePath,Timeline:Timeline};export default timelineClasses;