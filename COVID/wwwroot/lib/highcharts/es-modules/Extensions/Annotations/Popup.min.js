import H from"../../Core/Globals.js";var doc=H.doc,isFirefox=H.isFirefox;import NavigationBindings from"./NavigationBindings.js";import D from"../../Core/DefaultOptions.js";var getOptions=D.getOptions;import Pointer from"../../Core/Pointer.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,defined=U.defined,fireEvent=U.fireEvent,isArray=U.isArray,isObject=U.isObject,isString=U.isString,objectEach=U.objectEach,pick=U.pick,stableSort=U.stableSort,wrap=U.wrap,indexFilter=/\d/g,PREFIX="highcharts-",DIV="div",INPUT="input",LABEL="label",BUTTON="button",SELECT="select",OPTION="option",SPAN="span",UL="ul",LI="li",H3="h3";wrap(Pointer.prototype,"onContainerMouseDown",function(t,e){var i=e.target&&e.target.className;isString(i)&&0<=i.indexOf(PREFIX+"popup-field")||t.apply(this,Array.prototype.slice.call(arguments,1))}),H.Popup=function(t,e,i){this.init(t,e,i)},H.Popup.prototype={init:function(t,e,i){this.chart=i,this.container=createElement(DIV,{className:PREFIX+"popup highcharts-no-tooltip"},null,t),this.lang=this.getLangpack(),this.iconsURL=e,this.addCloseBtn()},addCloseBtn:function(){var e=this,t=this.iconsURL,i=createElement(DIV,{className:PREFIX+"popup-close"},null,this.container);i.style["background-image"]="url("+(t.match(/png|svg|jpeg|jpg|gif/gi)?t:t+"close.svg")+")",["click","touchstart"].forEach(function(t){addEvent(i,t,function(){e.chart?fireEvent(e.chart.navigationBindings,"closePopup"):e.closePopup()})})},addColsContainer:function(t){var e=createElement(DIV,{className:PREFIX+"popup-lhs-col"},null,t),t=createElement(DIV,{className:PREFIX+"popup-rhs-col"},null,t);return createElement(DIV,{className:PREFIX+"popup-rhs-col-wrapper"},null,t),{lhsCol:e,rhsCol:t}},addInput:function(t,e,i,a){var o=t.split("."),n=o[o.length-1],o=this.lang,e=PREFIX+e+"-"+n;e.match(indexFilter)||createElement(LABEL,{htmlFor:e},void 0,i).appendChild(doc.createTextNode(o[n]||n)),createElement(INPUT,{name:e,value:a[0],type:a[1],className:PREFIX+"popup-field"},void 0,i).setAttribute(PREFIX+"data-name",t)},addButton:function(t,e,i,a,o){var n=this,s=this.closePopup,l=this.getFields,r=createElement(BUTTON,void 0,void 0,t);return r.appendChild(doc.createTextNode(e)),["click","touchstart"].forEach(function(t){addEvent(r,t,function(){return s.call(n),a(l(o,i))})}),r},getFields:function(t,e){var i,a=t.querySelectorAll("input"),o="#"+PREFIX+"select-volume > option:checked",n=t.querySelectorAll("#"+PREFIX+"select-series > option:checked")[0],o=t.querySelectorAll(o)[0],s={actionType:e,linkedTo:n&&n.getAttribute("value"),fields:{}};return[].forEach.call(a,function(t){i=t.getAttribute(PREFIX+"data-name"),t.getAttribute(PREFIX+"data-series-id")?s.seriesId=t.value:i?s.fields[i]=t.value:s.type=t.value}),o&&(s.fields["params.volumeSeriesID"]=o.getAttribute("value")),s},showPopup:function(){var t=this.container,e=PREFIX+"annotation-toolbar",i=t.querySelectorAll("."+PREFIX+"popup-close")[0];t.innerHTML="",0<=t.className.indexOf(e)&&(t.classList.remove(e),t.removeAttribute("style")),t.appendChild(i),t.style.display="block",t.style.height=""},closePopup:function(){pick(this.popup&&this.popup.container,this.container).style.display="none"},showForm:function(t,e,i,a){e&&(this.popup=e.navigationBindings.popup,this.showPopup(),"indicators"===t&&this.indicators.addForm.call(this,e,i,a),"annotation-toolbar"===t&&this.annotations.addToolbar.call(this,e,i,a),"annotation-edit"===t&&this.annotations.addForm.call(this,e,i,a),"flag"===t&&this.annotations.addForm.call(this,e,i,a,!0),this.container.style.height=this.container.offsetHeight+"px")},getLangpack:function(){return getOptions().lang.navigation.popup},annotations:{addToolbar:function(t,e,i){var a=this,o=this.lang,n=this.popup.container,s=this.showForm,l=PREFIX+"annotation-toolbar";-1===n.className.indexOf(l)&&(n.className+=" "+l),t&&(n.style.top=t.plotTop+10+"px"),createElement(SPAN,void 0,void 0,n).appendChild(doc.createTextNode(pick(o[e.langKey]||e.langKey,e.shapes&&e.shapes[0].type))),(l=this.addButton(n,o.removeButton||"remove","remove",i,n)).className+=" "+PREFIX+"annotation-remove-button",l.style["background-image"]="url("+this.iconsURL+"destroy.svg)",(l=this.addButton(n,o.editButton||"edit","edit",function(){s.call(a,"annotation-edit",t,e,i)},n)).className+=" "+PREFIX+"annotation-edit-button",l.style["background-image"]="url("+this.iconsURL+"edit.svg)"},addForm:function(t,e,i,a){var o,n,s=this.popup.container,l=this.lang;t&&((n=createElement("h2",{className:PREFIX+"popup-main-title"},void 0,s)).appendChild(doc.createTextNode(l[e.langKey]||e.langKey||"")),n=createElement(DIV,{className:PREFIX+"popup-lhs-col "+PREFIX+"popup-lhs-full"},null,s),o=createElement(DIV,{className:PREFIX+"popup-bottom-row"},null,s),this.annotations.addFormFields.call(this,n,t,"",e,[],!0),this.addButton(o,a?l.addButton||"add":l.saveButton||"save",a?"add":"save",i,s))},addFormFields:function(i,a,o,t,n,e){var s,l,r=this,c=this.annotations.addFormFields,d=this.addInput,p=this.lang;a&&(objectEach(t,function(t,e){s=""!==o?o+"."+e:e,isObject(t)&&(!isArray(t)||isArray(t)&&isObject(t[0])?((l=p[e]||e).match(indexFilter)||n.push([!0,l,i]),c.call(r,i,a,s,t,n,!1)):n.push([r,s,"annotation",i,t]))}),e&&(stableSort(n,function(t){return t[1].match(/format/g)?-1:1}),isFirefox&&n.reverse(),n.forEach(function(t){!0===t[0]?createElement(SPAN,{className:PREFIX+"annotation-title"},void 0,t[2]).appendChild(doc.createTextNode(t[1])):d.apply(t[0],t.splice(1))})))}},indicators:{addForm:function(t,e,i){var a,o,n=this.indicators,s=this.lang;t&&(this.tabs.init.call(this,t),a=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content"),this.addColsContainer(a[0]),n.addIndicatorList.call(this,t,a[0],"add"),o=a[0].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(o,s.addButton||"add","add",i,o),this.addColsContainer(a[1]),n.addIndicatorList.call(this,t,a[1],"edit"),o=a[1].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(o,s.saveButton||"save","edit",i,o),this.addButton(o,s.removeButton||"remove","remove",i,o))},addIndicatorList:function(n,t,e){var s,l,r,c=this,i=t.querySelectorAll("."+PREFIX+"popup-lhs-col")[0],t=t.querySelectorAll("."+PREFIX+"popup-rhs-col")[0],d="edit"===e,p=d?n.series:n.options.plotOptions,u=this.indicators.addFormFields;n&&(l=createElement(UL,{className:PREFIX+"indicator-list"},null,i),s=t.querySelectorAll("."+PREFIX+"popup-rhs-col-wrapper")[0],objectEach(p,function(e,t){var i,a,o=e.options;(e.params||o&&o.params)&&(i=c.indicators.getNameType(e,t),a=i.type,(r=createElement(LI,{className:PREFIX+"indicator-list"},void 0,l)).appendChild(doc.createTextNode(i.name)),["click","touchstart"].forEach(function(t){addEvent(r,t,function(){u.call(c,n,d?e:p[a],i.type,s),d&&e.options&&createElement(INPUT,{type:"hidden",name:PREFIX+"id-"+a,value:e.options.id},null,s).setAttribute(PREFIX+"data-series-id",e.options.id)})}))}),0<l.childNodes.length&&l.childNodes[0].click())},getNameType:function(t,e){var i=t.options,a=H.seriesTypes,a=a[e]&&a[e].prototype.nameBase||e.toUpperCase(),e=e;return i&&i.type&&(e=t.options.type,a=t.name),{name:a,type:e}},listAllSeries:function(t,e,i,a,o){var n,s,l=PREFIX+e+"-type-"+t,t=this.lang;i&&(createElement(LABEL,{htmlFor:l},null,a).appendChild(doc.createTextNode(t[e]||e)),(n=createElement(SELECT,{name:l,className:PREFIX+"popup-field"},null,a)).setAttribute("id",PREFIX+"select-"+e),i.series.forEach(function(t){!(s=t.options).params&&s.id&&s.id!==PREFIX+"navigator-series"&&createElement(OPTION,{value:s.id},null,n).appendChild(doc.createTextNode(s.name||s.id))}),defined(o)&&(n.value=o))},addFormFields:function(t,e,i,a){var o=e.params||e.options.params,n=this.indicators.getNameType;a.innerHTML="",createElement(H3,{className:PREFIX+"indicator-title"},void 0,a).appendChild(doc.createTextNode(n(e,i).name)),createElement(INPUT,{type:"hidden",name:PREFIX+"type-"+i,value:i},null,a),this.indicators.listAllSeries.call(this,i,"series",t,a,e.linkedParent&&o.volumeSeriesID),o.volumeSeriesID&&this.indicators.listAllSeries.call(this,i,"volume",t,a,e.linkedParent&&e.linkedParent.options.id),this.indicators.addParamInputs.call(this,t,"params",o,i,a)},addParamInputs:function(i,a,t,o,n){var s,l=this,r=this.indicators.addParamInputs,c=this.addInput;i&&objectEach(t,function(t,e){s=a+"."+e,void 0!==t&&(isObject(t)?r.call(l,i,s,t,o,n):"params.volumeSeriesID"!=s&&c.call(l,s,o,n,[t,"text"]))})},getAmount:function(){var t=this.series,i=0;return t.forEach(function(t){var e=t.options;(t.params||e&&e.params)&&i++}),i}},tabs:{init:function(t){var e=this.tabs,i=this.indicators.getAmount.call(t);t&&(t=e.addMenuItem.call(this,"add"),e.addMenuItem.call(this,"edit",i),e.addContentItem.call(this,"add"),e.addContentItem.call(this,"edit"),e.switchTabs.call(this,i),e.selectTab.call(this,t,0))},addMenuItem:function(t,e){var i=this.popup.container,a=PREFIX+"tab-item",o=this.lang;return 0===e&&(a+=" "+PREFIX+"tab-disabled"),(i=createElement(SPAN,{className:a},void 0,i)).appendChild(doc.createTextNode(o[t+"Button"]||t)),i.setAttribute(PREFIX+"data-tab-type",t),i},addContentItem:function(){var t=this.popup.container;return createElement(DIV,{className:PREFIX+"tab-item-content "+PREFIX+"no-mousewheel"},null,t)},switchTabs:function(t){var a=this;this.popup.container.querySelectorAll("."+PREFIX+"tab-item").forEach(function(e,i){"edit"===e.getAttribute(PREFIX+"data-tab-type")&&0===t||["click","touchstart"].forEach(function(t){addEvent(e,t,function(){a.tabs.deselectAll.call(a),a.tabs.selectTab.call(a,this,i)})})})},selectTab:function(t,e){var i=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content");t.className+=" "+PREFIX+"tab-item-active",i[e].className+=" "+PREFIX+"tab-item-show"},deselectAll:function(){for(var t=this.popup.container,e=t.querySelectorAll("."+PREFIX+"tab-item"),i=t.querySelectorAll("."+PREFIX+"tab-item-content"),a=0;a<e.length;a++)e[a].classList.remove(PREFIX+"tab-item-active"),i[a].classList.remove(PREFIX+"tab-item-show")}}},addEvent(NavigationBindings,"showPopup",function(t){this.popup||(this.popup=new H.Popup(this.chart.container,this.chart.options.navigation.iconsURL||this.chart.options.stockTools&&this.chart.options.stockTools.gui.iconsURL||"https://code.highcharts.com/9.1.2/gfx/stock-icons/",this.chart)),this.popup.showForm(t.formType,this.chart,t.options,t.onSubmit)}),addEvent(NavigationBindings,"closePopup",function(){this.popup&&this.popup.closePopup()});export default H.Popup;