"use strict";import Annotation from"./Annotations.js";import Chart from"../../Core/Chart/Chart.js";import chartNavigationMixin from"../../Mixins/Navigation.js";import F from"../../Core/FormatUtilities.js";var format=F.format;import H from"../../Core/Globals.js";import D from"../../Core/DefaultOptions.js";var setOptions=D.setOptions;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,attr=U.attr,fireEvent=U.fireEvent,isArray=U.isArray,isFunction=U.isFunction,isNumber=U.isNumber,isObject=U.isObject,merge=U.merge,objectEach=U.objectEach,pick=U.pick,doc=H.doc,win=H.win,PREFIX="highcharts-";function closestPolyfill(t,n){var i=win.Element.prototype,e=i.matches||i.msMatchesSelector||i.webkitMatchesSelector,o=null;if(i.closest)o=i.closest.call(t,n);else do{if(e.call(t,n))return t}while(null!==(t=t.parentElement||t.parentNode)&&1===t.nodeType);return o}var bindingsUtils={getFieldType:function(t){return{string:"text",number:"number",boolean:"checkbox"}[typeof t]},updateRectSize:function(t,n){var i=n.chart,e=n.options.typeOptions,o=i.pointer.getCoordinates(t),t=i.navigationBindings.utils.getAssignedAxis(o.xAxis),o=i.navigationBindings.utils.getAssignedAxis(o.yAxis);t&&o&&(t=t.value-e.point.x,o=e.point.y-o.value,n.update({typeOptions:{background:{width:i.inverted?o:t,height:i.inverted?t:o}}}))},getAssignedAxis:function(t){return t.filter(function(t){var n=t.axis.min,i=t.axis.max,e=pick(t.axis.minPointOffset,0);return isNumber(n)&&isNumber(i)&&t.value>=n-e&&t.value<=i+e&&!t.axis.options.isInternal})[0]}},NavigationBindings=function(){function t(t,n){this.boundClassNames=void 0,this.selectedButton=void 0,this.chart=t,this.options=n,this.eventsToUnbind=[],this.container=doc.getElementsByClassName(this.options.bindingsClassName||"")}return t.prototype.initEvents=function(){var e=this,n=e.chart,t=e.container,i=e.options;e.boundClassNames={},objectEach(i.bindings||{},function(t){e.boundClassNames[t.className]=t}),[].forEach.call(t,function(i){e.eventsToUnbind.push(addEvent(i,"click",function(t){var n=e.getButtonEvents(i,t);n&&-1===n.button.className.indexOf("highcharts-disabled-btn")&&e.bindingsButtonClick(n.button,n.events,t)}))}),objectEach(i.events||{},function(t,n){isFunction(t)&&e.eventsToUnbind.push(addEvent(e,n,t,{passive:!1}))}),e.eventsToUnbind.push(addEvent(n.container,"click",function(t){!n.cancelClick&&n.isInsidePlot(t.chartX-n.plotLeft,t.chartY-n.plotTop,{visiblePlotOnly:!0})&&e.bindingsChartClick(this,t)})),e.eventsToUnbind.push(addEvent(n.container,H.isTouchDevice?"touchmove":"mousemove",function(t){e.bindingsContainerMouseMove(this,t)},H.isTouchDevice?{passive:!1}:void 0))},t.prototype.initUpdate=function(){var n=this;chartNavigationMixin.addUpdate(function(t){n.update(t)},this.chart)},t.prototype.bindingsButtonClick=function(t,n,i){var e=this,o=e.chart;e.selectedButtonElement&&(fireEvent(e,"deselectButton",{button:e.selectedButtonElement}),e.nextEvent&&(e.currentUserDetails&&"annotations"===e.currentUserDetails.coll&&o.removeAnnotation(e.currentUserDetails),e.mouseMoveEvent=e.nextEvent=!1)),e.selectedButton=n,e.selectedButtonElement=t,fireEvent(e,"selectButton",{button:t}),n.init&&n.init.call(e,t,i),(n.start||n.steps)&&o.renderer.boxWrapper.addClass(PREFIX+"draw-mode")},t.prototype.bindingsChartClick=function(t,n){t=this.chart;var i=this,e=i.selectedButton,t=t.renderer.boxWrapper;i.activeAnnotation&&!n.activeAnnotation&&n.target.parentNode&&!closestPolyfill(n.target,"."+PREFIX+"popup")&&fireEvent(i,"closePopup"),e&&e.start&&(i.nextEvent?(i.nextEvent(n,i.currentUserDetails),i.steps&&(i.stepIndex++,e.steps[i.stepIndex]?i.mouseMoveEvent=i.nextEvent=e.steps[i.stepIndex]:(fireEvent(i,"deselectButton",{button:i.selectedButtonElement}),t.removeClass(PREFIX+"draw-mode"),e.end&&e.end.call(i,n,i.currentUserDetails),i.nextEvent=!1,i.mouseMoveEvent=!1,i.selectedButton=null))):(i.currentUserDetails=e.start.call(i,n),i.currentUserDetails&&e.steps?(i.stepIndex=0,i.steps=!0,i.mouseMoveEvent=i.nextEvent=e.steps[i.stepIndex]):(fireEvent(i,"deselectButton",{button:i.selectedButtonElement}),t.removeClass(PREFIX+"draw-mode"),i.steps=!1,i.selectedButton=null,e.end&&e.end.call(i,n,i.currentUserDetails))))},t.prototype.bindingsContainerMouseMove=function(t,n){this.mouseMoveEvent&&this.mouseMoveEvent(n,this.currentUserDetails)},t.prototype.fieldsToOptions=function(t,i){return objectEach(t,function(e,t){var n=parseFloat(e),o=t.split("."),s=i,a=o.length-1;""!==(e=isNumber(n)&&!e.match(/px/g)&&!t.match(/format/g)?n:e)&&"undefined"!==e&&o.forEach(function(t,n){var i=pick(o[n+1],"");a===n?s[t]=e:s=s[t]||(s[t]=i.match(/\d/g)?[]:{},s[t])})}),i},t.prototype.deselectAnnotation=function(){this.activeAnnotation&&(this.activeAnnotation.setControlPointsVisibility(!1),this.activeAnnotation=!1)},t.prototype.annotationToFields=function(n){var e=n.options,o=t.annotationsEditable,a=o.nestedOptions,r=this.utils.getFieldType,s=pick(e.type,e.shapes&&e.shapes[0]&&e.shapes[0].type,e.labels&&e.labels[0]&&e.labels[0].itemType,"label"),c=t.annotationsNonEditable[e.langKey]||[],l={langKey:e.langKey,type:s};function d(t,e,i,o){var s;i&&t&&-1===c.indexOf(e)&&(0<=(i.indexOf&&i.indexOf(e))||i[e]||!0===i)&&(isArray(t)?(o[e]=[],t.forEach(function(t,i){isObject(t)?(o[e][i]={},objectEach(t,function(t,n){d(t,n,a[e],o[e][i])})):d(t,0,a[e],o[e])})):isObject(t)?(s={},isArray(o)?(o.push(s),s[e]={},s=s[e]):o[e]=s,objectEach(t,function(t,n){d(t,n,0===e?i:a[e],s)})):"format"===e?o[e]=[format(t,n.labels[0].points[0]).toString(),"text"]:isArray(o)?o.push([t,r(t)]):o[e]=[t,r(t)])}return objectEach(e,function(t,i){"typeOptions"===i?(l[i]={},objectEach(e[i],function(t,n){d(t,n,a,l[i])})):d(t,i,o[s],l)}),l},t.prototype.getClickedClassNames=function(t,n){for(var i,e=n.target,o=[];e;)if((i=attr(e,"class"))&&(o=o.concat(i.split(" ").map(function(t){return[t,e]}))),(e=e.parentNode)===t)return o;return o},t.prototype.getButtonEvents=function(t,n){var i,e=this;return this.getClickedClassNames(t,n).forEach(function(t){e.boundClassNames[t[0]]&&!i&&(i={events:e.boundClassNames[t[0]],button:t[1]})}),i},t.prototype.update=function(t){this.options=merge(!0,this.options,t),this.removeEvents(),this.initEvents()},t.prototype.removeEvents=function(){this.eventsToUnbind.forEach(function(t){t()})},t.prototype.destroy=function(){this.removeEvents()},t.annotationsEditable={nestedOptions:{labelOptions:["style","format","backgroundColor"],labels:["style"],label:["style"],style:["fontSize","color"],background:["fill","strokeWidth","stroke"],innerBackground:["fill","strokeWidth","stroke"],outerBackground:["fill","strokeWidth","stroke"],shapeOptions:["fill","strokeWidth","stroke"],shapes:["fill","strokeWidth","stroke"],line:["strokeWidth","stroke"],backgroundColors:[!0],connector:["fill","strokeWidth","stroke"],crosshairX:["strokeWidth","stroke"],crosshairY:["strokeWidth","stroke"]},circle:["shapes"],verticalLine:[],label:["labelOptions"],measure:["background","crosshairY","crosshairX"],fibonacci:[],tunnel:["background","line","height"],pitchfork:["innerBackground","outerBackground"],rect:["shapes"],crookedLine:[],basicAnnotation:["shapes","labelOptions"]},t.annotationsNonEditable={rectangle:["crosshairX","crosshairY","label"]},t}();function selectableAnnotation(t){var o=t.prototype.defaultOptions.events&&t.prototype.defaultOptions.events.click;merge(!0,t.prototype.defaultOptions.events,{click:function(t){var i=this,e=i.chart.navigationBindings,n=e.activeAnnotation;o&&o.call(i,t),n!==i?(e.deselectAnnotation(),(e.activeAnnotation=i).setControlPointsVisibility(!0),fireEvent(e,"showPopup",{annotation:i,formType:"annotation-toolbar",options:e.annotationToFields(i),onSubmit:function(t){var n={};"remove"===t.actionType?(e.activeAnnotation=!1,e.chart.removeAnnotation(i)):(e.fieldsToOptions(t.fields,n),e.deselectAnnotation(),t=n.typeOptions,"measure"===i.options.type&&(t.crosshairY.enabled=0!==t.crosshairY.strokeWidth,t.crosshairX.enabled=0!==t.crosshairX.strokeWidth),i.update(n))}})):fireEvent(e,"closePopup"),t.activeAnnotation=!0}})}NavigationBindings.prototype.utils=bindingsUtils,Chart.prototype.initNavigationBindings=function(){var t=this,n=t.options;n&&n.navigation&&n.navigation.bindings&&(t.navigationBindings=new NavigationBindings(t,n.navigation),t.navigationBindings.initEvents(),t.navigationBindings.initUpdate())},addEvent(Chart,"load",function(){this.initNavigationBindings()}),addEvent(Chart,"destroy",function(){this.navigationBindings&&this.navigationBindings.destroy()}),addEvent(NavigationBindings,"deselectButton",function(){this.selectedButtonElement=null}),addEvent(Annotation,"remove",function(){this.chart.navigationBindings&&this.chart.navigationBindings.deselectAnnotation()}),H.Annotation&&(selectableAnnotation(Annotation),objectEach(Annotation.types,function(t){selectableAnnotation(t)})),setOptions({lang:{navigation:{popup:{simpleShapes:"Simple shapes",lines:"Lines",circle:"Circle",rectangle:"Rectangle",label:"Label",shapeOptions:"Shape options",typeOptions:"Details",fill:"Fill",format:"Text",strokeWidth:"Line width",stroke:"Line color",title:"Title",name:"Name",labelOptions:"Label options",labels:"Labels",backgroundColor:"Background color",backgroundColors:"Background colors",borderColor:"Border color",borderRadius:"Border radius",borderWidth:"Border width",style:"Style",padding:"Padding",fontSize:"Font size",color:"Color",height:"Height",shapes:"Shape options"}}},navigation:{bindingsClassName:"highcharts-bindings-container",bindings:{circleAnnotation:{className:"highcharts-circle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.utils.getAssignedAxis(n.xAxis),t=this.utils.getAssignedAxis(n.yAxis),n=this.chart.options.navigation;if(i&&t)return this.chart.addAnnotation(merge({langKey:"circle",type:"basicAnnotation",shapes:[{type:"circle",point:{x:i.value,y:t.value,xAxis:i.axis.options.index,yAxis:t.axis.options.index},r:5}]},n.annotationsOptions,n.bindings.circleAnnotation.annotationsOptions))},steps:[function(t,n){var i,e,o=n.options.shapes[0].point,s=this.chart.inverted;isNumber(o.xAxis)&&isNumber(o.yAxis)&&(i=this.chart.xAxis[o.xAxis].toPixels(o.x),e=this.chart.yAxis[o.yAxis].toPixels(o.y),e=Math.max(Math.sqrt(Math.pow(s?e-t.chartX:i-t.chartX,2)+Math.pow(s?i-t.chartY:e-t.chartY,2)),5)),n.update({shapes:[{r:e}]})}]},rectangleAnnotation:{className:"highcharts-rectangle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.utils.getAssignedAxis(n.xAxis),e=this.utils.getAssignedAxis(n.yAxis);if(i&&e){var o=i.value,t=e.value,n=i.axis.options.index,i=e.axis.options.index,e=this.chart.options.navigation;return this.chart.addAnnotation(merge({langKey:"rectangle",type:"basicAnnotation",shapes:[{type:"path",points:[{xAxis:n,yAxis:i,x:o,y:t},{xAxis:n,yAxis:i,x:o,y:t},{xAxis:n,yAxis:i,x:o,y:t},{xAxis:n,yAxis:i,x:o,y:t}]}]},e.annotationsOptions,e.bindings.rectangleAnnotation.annotationsOptions))}},steps:[function(t,n){var i=n.options.shapes[0].points,e=this.chart.pointer.getCoordinates(t),t=this.utils.getAssignedAxis(e.xAxis),e=this.utils.getAssignedAxis(e.yAxis);t&&e&&(t=t.value,e=e.value,i[1].x=t,i[2].x=t,i[2].y=e,i[3].y=e,n.update({shapes:[{points:i}]}))}]},labelAnnotation:{className:"highcharts-label-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.utils.getAssignedAxis(n.xAxis),t=this.utils.getAssignedAxis(n.yAxis),n=this.chart.options.navigation;if(i&&t)return this.chart.addAnnotation(merge({langKey:"label",type:"basicAnnotation",labelOptions:{format:"{y:.2f}"},labels:[{point:{xAxis:i.axis.options.index,yAxis:t.axis.options.index,x:i.value,y:t.value},overflow:"none",crop:!0}]},n.annotationsOptions,n.bindings.labelAnnotation.annotationsOptions))}}},events:{},annotationsOptions:{animation:{defer:0}}}}),addEvent(Chart,"render",function(){var i,e=this,t=e.navigationBindings,o="highcharts-disabled-btn";e&&t&&(i=!1,e.series.forEach(function(t){!t.options.isInternal&&t.visible&&(i=!0)}),objectEach(t.boundClassNames,function(t,n){e.navigationBindings&&e.navigationBindings.container&&e.navigationBindings.container[0]&&((n=e.navigationBindings.container[0].querySelectorAll("."+n))&&("normal"===t.noDataState?n.forEach(function(t){-1!==t.className.indexOf(o)&&t.classList.remove(o)}):i?n.forEach(function(t){-1!==t.className.indexOf(o)&&t.classList.remove(o)}):n.forEach(function(t){-1===t.className.indexOf(o)&&(t.className+=" "+o)})))}))}),addEvent(NavigationBindings,"closePopup",function(){this.deselectAnnotation()});export default NavigationBindings;