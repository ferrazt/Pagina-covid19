"use strict";import Ajax from"../Extensions/Ajax.js";var ajax=Ajax.ajax;import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var doc=H.doc;import Point from"../Core/Series/Point.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import U from"../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,splat=U.splat,Data=function(){function e(e,t,r){this.chart=void 0,this.chartOptions=void 0,this.firstRowAsNames=void 0,this.rawColumns=void 0,this.options=void 0,this.dateFormats={"YYYY/mm/dd":{regex:/^([0-9]{4})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{1,2})$/,parser:function(e){return e?Date.UTC(+e[1],e[2]-1,+e[3]):NaN}},"dd/mm/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[2]-1,+e[1]):NaN},alternative:"mm/dd/YYYY"},"mm/dd/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[1]-1,+e[2]):NaN}},"dd/mm/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){if(!e)return NaN;var t=+e[3];return t>(new Date).getFullYear()-2e3?t+=1900:t+=2e3,Date.UTC(t,e[2]-1,+e[1])},alternative:"mm/dd/YY"},"mm/dd/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){return e?Date.UTC(+e[3]+2e3,e[1]-1,+e[2]):NaN}}},this.init(e,t,r)}return e.prototype.init=function(e,t,r){var o,i=e.decimalPoint;t&&(this.chartOptions=t),r&&(this.chart=r),"."!==i&&","!==i&&(i=void 0),this.options=e,this.columns=e.columns||this.rowsToColumns(e.rows)||[],this.firstRowAsNames=pick(e.firstRowAsNames,this.firstRowAsNames,!0),this.decimalRegex=i&&new RegExp("^(-?[0-9]+)"+i+"([0-9]+)$"),this.rawColumns=[],this.columns.length&&(this.dataFound(),o=!0),this.hasURLOption(e)&&(clearTimeout(this.liveDataTimeout),o=!1),!(o=(o=(o=(o=o||this.fetchLiveData())||Boolean(this.parseCSV().length))||Boolean(this.parseTable().length))||this.parseGoogleSpreadsheet())&&e.afterComplete&&e.afterComplete()},e.prototype.hasURLOption=function(e){return Boolean(e&&(e.rowsURL||e.csvURL||e.columnsURL))},e.prototype.getColumnDistribution=function(){function n(e){return(seriesTypes[e||"line"].prototype.pointArrayMap||[0]).length}function a(e){return seriesTypes[e||"line"].prototype.pointArrayMap}var l,u=this.chartOptions,e=this.options,t=[],h=u&&u.chart&&u.chart.type,d=[],p=[],m=0,e=e&&e.seriesMapping||u&&u.series&&u.series.map(function(){return{x:0}})||[];(u&&u.series||[]).forEach(function(e){d.push(n(e.type||h))}),e.forEach(function(e){t.push(e.x||0)}),0===t.length&&t.push(0),e.forEach(function(e){var r=new SeriesBuilder,t=d[m]||n(h),o=(u&&u.series||[])[m]||{},i=a(o.type||h),s=i||["y"];for(!defined(e.x)&&!o.isCartesian&&i||r.addColumnReader(e.x,"x"),objectEach(e,function(e,t){"x"!==t&&r.addColumnReader(e,t)}),l=0;l<t;l++)r.hasReader(s[l])||r.addColumnReader(void 0,s[l]);p.push(r),m++});e=a(h);this.valueCount={global:n(h),xColumns:t,individual:d,seriesBuilders:p,globalPointArrayMap:e=void 0===e?["y"]:e}},e.prototype.dataFound=function(){this.options.switchRowsAndColumns&&(this.columns=this.rowsToColumns(this.columns)),this.getColumnDistribution(),this.parseTypes(),!1!==this.parsed()&&this.complete()},e.prototype.parseCSV=function(e){var c,t,l,u,r,d=this,p=e||this.options,e=p.csv,o=void 0!==p.startRow&&p.startRow?p.startRow:0,i=p.endRow||Number.MAX_VALUE,f=void 0!==p.startColumn&&p.startColumn?p.startColumn:0,g=p.endColumn||Number.MAX_VALUE,s=0,v=[],h={",":0,";":0,"\t":0};if(c=this.columns=[],e=e&&p.beforeParse?p.beforeParse.call(this,e):e){t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(p.lineDelimiter||"\n"),(!o||o<0)&&(o=0),(!i||i>=t.length)&&(i=t.length-1);for(var x=p.itemDelimiter||(x=null,u=l=0,r=!1,t.some(function(e,t){var r,o,i,s=!1,n="";if(13<t)return!0;for(var a=0;a<e.length;a++){if(r=e[a],o=e[a+1],i=e[a-1],"#"===r)return;if('"'===r)if(s){if('"'!==i&&'"'!==o){for(;" "===o&&a<e.length;)o=e[++a];void 0!==h[o]&&h[o]++,s=!1}}else s=!0;else void 0!==h[r]?(n=n.trim(),isNaN(Date.parse(n))&&!isNaN(n)&&isFinite(n)||h[r]++,n=""):n+=r;","===r&&u++,"."===r&&l++}}),r=h[";"]>h[","]?";":(h[","],h[";"],","),p.decimalPoint||(p.decimalPoint=u<l?".":",",d.decimalRegex=new RegExp("^(-?[0-9]+)"+p.decimalPoint+"([0-9]+)$")),r),n=0,s=o;s<=i;s++)"#"===t[s][0]?n++:function(t,e,r,o){var i=0,s="",n="",a="",l="",u=0,h=0;function d(e){s=t[e],n=t[e-1],a=t[e+1]}function p(e){v.length<h+1&&v.push([e]),v[h][v[h].length-1]!==e&&v[h].push(e)}function m(){if(u<f||g<u)return++u,void(l="");!isNaN(parseFloat(l))&&isFinite(l)?(l=parseFloat(l),p("number")):isNaN(Date.parse(l))?p("string"):(l=l.replace(/\//g,"-"),p("date")),c.length<h+1&&c.push([]),r||(c[h][e]=l),l="",++h,++u}if(t.trim().length&&"#"!==t.trim()[0]){for(;i<t.length;i++)if(d(i),'"'===s)for(d(++i);i<t.length&&('"'!==s||'"'===n||'"'===a);)('"'!==s||'"'===s&&'"'!==n)&&(l+=s),d(++i);else o&&o[s]?o[s](s,l)&&m():s===x?m():l+=s;m()}}(t[s],s-o-n);p.columnTypes&&0!==p.columnTypes.length||!v.length||!v[0].length||"date"!==v[0][1]||p.dateFormat||(p.dateFormat=function(e,t){var r,o,i,s="YYYY/mm/dd",n=[],a=0,l=!1,u=[],h=[];for((!t||t>e.length)&&(t=e.length);a<t;a++)if(void 0!==e[a]&&e[a]&&e[a].length)for(r=e[a].trim().replace(/\//g," ").replace(/\-/g," ").replace(/\./g," ").split(" "),n=["","",""],i=0;i<r.length;i++)i<n.length&&(r[i]=parseInt(r[i],10),r[i]&&(h[i]=(!h[i]||h[i]<r[i]?r:h)[i],void 0!==u[i]?u[i]!==r[i]&&(u[i]=!1):u[i]=r[i],31<r[i]?r[i]<100?n[i]="YY":n[i]="YYYY":12<r[i]&&r[i]<=31?(n[i]="dd",l=!0):n[i].length||(n[i]="mm")));if(l){for(i=0;i<u.length;i++)!1!==u[i]?12<h[i]&&"YY"!==n[i]&&"YYYY"!==n[i]&&(n[i]="YY"):12<h[i]&&"mm"===n[i]&&(n[i]="dd");return 3===n.length&&"dd"===n[1]&&"dd"===n[2]&&(n[2]="YY"),o=n.join("/"),(p.dateFormats||d.dateFormats)[o]?o:(fireEvent("deduceDateFailed"),s)}return s}(c[0])),this.dataFound()}return c},e.prototype.parseTable=function(){var e=this.options,t=e.table,s=this.columns||[],n=e.startRow||0,r=e.endRow||Number.MAX_VALUE,a=e.startColumn||0,l=e.endColumn||Number.MAX_VALUE;return t&&("string"==typeof t&&(t=doc.getElementById(t)),[].forEach.call(t.getElementsByTagName("tr"),function(e,i){n<=i&&i<=r&&[].forEach.call(e.children,function(e,t){var r=s[t-a],o=1;if(("TD"===e.tagName||"TH"===e.tagName)&&a<=t&&t<=l)for(s[t-a]||(s[t-a]=[]),s[t-a][i-n]=e.innerHTML;o<=i-n&&void 0===r[i-n-o];)r[i-n-o]=null,o++})}),this.dataFound()),s},e.prototype.fetchLiveData=function(){var n=this,a=this.chart,l=this.options,u=3,h=0,d=l.enablePolling,p=1e3*(l.dataRefreshRate||2),t=merge(l);return!!this.hasURLOption(l)&&(p<1e3&&(p=1e3),delete l.csvURL,delete l.rowsURL,delete l.columnsURL,function i(s){function e(e,t,r){if(e&&/^(http|\/|\.\/|\.\.\/)/.test(e))return s&&(clearTimeout(n.liveDataTimeout),a.liveDataURL=e),ajax({url:e,dataType:r||"json",success:function(e){a&&a.series&&t(e),o()},error:function(e,t){return++h<u&&o(),l.error&&l.error(t,e)}}),1;function o(){d&&a.liveDataURL===e&&(n.liveDataTimeout=setTimeout(i,p))}e&&l.error&&l.error("Invalid URL")}e(t.csvURL,function(e){a.update({data:{csv:e}})},"text")||e(t.rowsURL,function(e){a.update({data:{rows:e}})})||e(t.columnsURL,function(e){a.update({data:{columns:e}})})}(!0),this.hasURLOption(l))},e.prototype.parseGoogleSpreadsheet=function(){var p=this,o=this.options,i=o.googleSpreadsheetKey,m=this.chart,s=o.googleSpreadsheetWorksheet||1,c=o.startRow||0,f=o.endRow||Number.MAX_VALUE,g=o.startColumn||0,v=o.endColumn||Number.MAX_VALUE;o.dataRefreshRate;return i&&(delete o.googleSpreadsheetKey,function t(r){var e=["https://spreadsheets.google.com/feeds/cells",i,s,"public/values?alt=json"].join("/");ajax({url:e,dataType:"json",success:function(e){r(e),o.enablePolling&&setTimeout(function(){t(r)},1e3*(o.dataRefreshRate||2))},error:function(e,t){return o.error&&o.error(t,e)}})}(function(e){var t,r,o,i,s,n,a=[],l=e.feed.entry,u=(l||[]).length,h=0,d=0;if(!l||0===l.length)return!1;for(n=0;n<u;n++)t=l[n],h=Math.max(h,t.gs$cell.col),d=Math.max(d,t.gs$cell.row);for(n=0;n<h;n++)g<=n&&n<=v&&(a[n-g]=[]);for(n=0;n<u;n++)o=(t=l[n]).gs$cell.row-1,i=t.gs$cell.col-1,g<=i&&i<=v&&c<=o&&o<=f&&(r=null,(s=t.gs$cell||t.content).numericValue?r=0<=s.$t.indexOf("/")||0<=s.$t.indexOf("-")?s.$t:0<s.$t.indexOf("%")?100*parseFloat(s.numericValue):parseFloat(s.numericValue):s.$t&&s.$t.length&&(r=s.$t),a[i-g][o-c]=r);a.forEach(function(e){for(n=0;n<e.length;n++)void 0===e[n]&&(e[n]=null)}),m&&m.series?m.update({data:{columns:a}}):(p.columns=a,p.dataFound())})),!1},e.prototype.trim=function(e,t){return"string"==typeof e&&(e=e.replace(/^\s+|\s+$/g,""),t&&/^[0-9\s]+$/.test(e)&&(e=e.replace(/\s/g,"")),this.decimalRegex&&(e=e.replace(this.decimalRegex,"$1.$2"))),e},e.prototype.parseTypes=function(){for(var e=this.columns,t=e.length;t--;)this.parseColumn(e[t],t)},e.prototype.parseColumn=function(e,t){var r,o,i,s,n,a,l=this.rawColumns,u=this.columns,h=e.length,d=this.firstRowAsNames,p=-1!==this.valueCount.xColumns.indexOf(t),m=[],c=this.chartOptions,f=(this.options.columnTypes||[])[t],g=p&&(c&&c.xAxis&&"category"===splat(c.xAxis)[0].type||"string"===f);for(l[t]||(l[t]=[]);h--;)n=m[h]||e[h],o=this.trim(n),i=this.trim(n,!0),r=parseFloat(i),void 0===l[t][h]&&(l[t][h]=o),g||0===h&&d?e[h]=""+o:+i===r?(31536e6<(e[h]=r)&&"float"!==f?e.isDatetime=!0:e.isNumeric=!0,void 0!==e[h+1]&&(a=r>e[h+1])):(o&&o.length&&(s=this.parseDate(n)),p&&isNumber(s)&&"float"!==f?(m[h]=n,e[h]=s,e.isDatetime=!0,void 0!==e[h+1]&&((n=s>e[h+1])!==a&&void 0!==a&&(this.alternativeFormat?(this.dateFormat=this.alternativeFormat,h=e.length,this.alternativeFormat=this.dateFormats[this.dateFormat].alternative):e.unsorted=!0),a=n)):(e[h]=""===o?null:o,0!==h&&(e.isDatetime||e.isNumeric)&&(e.mixed=!0)));if(p&&e.mixed&&(u[t]=l[t]),p&&a&&this.options.sort)for(t=0;t<u.length;t++)u[t].reverse(),d&&u[t].unshift(u[t].pop())},e.prototype.parseDate=function(e){var t,r,o,i,s=this.options.parseDate,n=this.options.dateFormat||this.dateFormat;if(s)t=s(e);else if("string"==typeof e){if(n)o=(o=this.dateFormats[n])||this.dateFormats["YYYY/mm/dd"],(i=e.match(o.regex))&&(t=o.parser(i));else for(r in this.dateFormats)if(o=this.dateFormats[r],i=e.match(o.regex)){this.dateFormat=n=r,this.alternativeFormat=o.alternative,t=o.parser(i);break}i||(e.match(/:.+(GMT|UTC|[Z+-])/)&&(e=e.replace(/\s*(?:GMT|UTC)?([+-])(\d\d)(\d\d)$/,"$1$2:$3").replace(/(?:\s+|GMT|UTC)([+-])/,"$1").replace(/(\d)\s*(?:GMT|UTC|Z)$/,"$1+00:00")),"object"==typeof(i=Date.parse(e))&&null!==i&&i.getTime?t=i.getTime()-6e4*i.getTimezoneOffset():isNumber(i)&&(t=i-6e4*new Date(i).getTimezoneOffset()))}return t},e.prototype.rowsToColumns=function(e){var t,r,o,i,s;if(e)for(s=[],r=e.length,t=0;t<r;t++)for(i=e[t].length,o=0;o<i;o++)s[o]||(s[o]=[]),s[o][t]=e[t][o];return s},e.prototype.getData=function(){if(this.columns)return this.rowsToColumns(this.columns).slice(1)},e.prototype.parsed=function(){if(this.options.parsed)return this.options.parsed.call(this,this.columns)},e.prototype.getFreeIndexes=function(e,t){for(var r,o,i=[],s=[],n=0;n<e;n+=1)i.push(!0);for(r=0;r<t.length;r+=1)for(o=t[r].getReferencedColumnIndexes(),n=0;n<o.length;n+=1)i[o[n]]=!1;for(n=0;n<i.length;n+=1)i[n]&&s.push(n);return s},e.prototype.complete=function(){var e,t,r,o,i,s,n,a,l,u,h,d=this.columns,p=this.options,m=[];if(d.length,p.complete||p.afterComplete){if(this.firstRowAsNames)for(o=0;o<d.length;o++)d[o].name=d[o].shift();for(t=[],l=this.getFreeIndexes(d.length,this.valueCount.seriesBuilders),n=0;n<this.valueCount.seriesBuilders.length;n++)(a=this.valueCount.seriesBuilders[n]).populateColumns(l)&&m.push(a);for(;0<l.length;){for((a=new SeriesBuilder).addColumnReader(0,"x"),-1!==(h=l.indexOf(0))&&l.splice(h,1),o=0;o<this.valueCount.global;o++)a.addColumnReader(void 0,this.valueCount.globalPointArrayMap[o]);a.populateColumns(l)&&m.push(a)}if(0<m.length&&0<m[0].readers.length&&void 0!==(u=d[m[0].readers[0].columnIndex])&&(u.isDatetime?e="datetime":u.isNumeric||(e="category")),"category"===e)for(n=0;n<m.length;n++)for(a=m[n],s=0;s<a.readers.length;s++)"x"===a.readers[s].configName&&(a.readers[s].configName="name");for(n=0;n<m.length;n++){for(a=m[n],r=[],i=0;i<d[0].length;i++)r[i]=a.read(d,i);t[n]={data:r},a.name&&(t[n].name=a.name),"category"===e&&(t[n].turboThreshold=0)}u={series:t},e&&(u.xAxis={type:e},"category"===e&&(u.xAxis.uniqueNames=!1)),p.complete&&p.complete(u),p.afterComplete&&p.afterComplete(u)}},e.prototype.update=function(e,t){var r=this.chart;e&&(e.afterComplete=function(e){e&&(e.xAxis&&r.xAxis[0]&&e.xAxis.type===r.xAxis[0].options.type&&delete e.xAxis,r.update(e,t,!0))},merge(!0,r.options.data,e),this.init(r.options.data))},e}();H.data=function(e,t,r){return new H.Data(e,t,r)},addEvent(Chart,"init",function(e){var o=this,i=e.args[0]||{},s=e.args[1];i&&i.data&&!o.hasDataDef&&(o.hasDataDef=!0,o.data=new H.Data(extend(i.data,{afterComplete:function(e){var t,r;if(Object.hasOwnProperty.call(i,"series"))if("object"==typeof i.series)for(t=Math.max(i.series.length,e&&e.series?e.series.length:0);t--;)r=i.series[t]||{},i.series[t]=merge(r,e&&e.series?e.series[t]:{});else delete i.series;i=merge(e,i),o.init(i,s)}}),i,o),e.preventDefault())});var SeriesBuilder=function(){function e(){this.readers=[],this.pointIsArray=!0,this.name=void 0}return e.prototype.populateColumns=function(t){var r=!0;return this.readers.forEach(function(e){void 0===e.columnIndex&&(e.columnIndex=t.shift())}),this.readers.forEach(function(e){void 0===e.columnIndex&&(r=!1)}),r},e.prototype.read=function(r,o){var e,i=this.pointIsArray,s=i?[]:{};return this.readers.forEach(function(e){var t=r[e.columnIndex][o];i?s.push(t):0<e.configName.indexOf(".")?Point.prototype.setNestedProperty(s,t,e.configName):s[e.configName]=t}),void 0===this.name&&2<=this.readers.length&&2<=(e=this.getReferencedColumnIndexes()).length&&(e.shift(),e.sort(function(e,t){return e-t}),this.name=r[e.shift()].name),s},e.prototype.addColumnReader=function(e,t){this.readers.push({columnIndex:e,configName:t}),"x"!==t&&"y"!==t&&void 0!==t&&(this.pointIsArray=!1)},e.prototype.getReferencedColumnIndexes=function(){for(var e,t=[],r=0;r<this.readers.length;r+=1)void 0!==(e=this.readers[r]).columnIndex&&t.push(e.columnIndex);return t},e.prototype.hasReader=function(e){for(var t=0;t<this.readers.length;t+=1)if(this.readers[t].configName===e)return!0},e}();H.Data=Data;export default H.Data;