import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var win=H.win,doc=H.doc;import D from"../Core/DefaultOptions.js";var getOptions=D.getOptions;import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,error=U.error,extend=U.extend,fireEvent=U.fireEvent,merge=U.merge;import DownloadURL from"../Extensions/DownloadURL.js";var downloadURL=DownloadURL.downloadURL,domurl=win.URL||win.webkitURL||win,loadEventDeferDelay=H.isMS?150:0;function getScript(t,e){var o=doc.getElementsByTagName("head")[0],n=doc.createElement("script");n.type="text/javascript",n.src=t,n.onload=e,n.onerror=function(){error("Error loading script "+t)},o.appendChild(n)}function svgToDataUrl(t){var e=win.navigator.userAgent,e=-1<e.indexOf("WebKit")&&e.indexOf("Chrome")<0;try{if(!e&&!H.isFirefox&&-1===t.indexOf("<foreignObject"))return domurl.createObjectURL(new win.Blob([t],{type:"image/svg+xml;charset-utf-16"}))}catch(t){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t)}function imageToDataUrl(n,r,i,a,l,t,c,e,d){function o(){setTimeout(function(){var t,e=doc.createElement("canvas"),o=e.getContext&&e.getContext("2d");try{if(o){e.height=g.height*a,e.width=g.width*a,o.drawImage(g,0,0,e.width,e.height);try{t=e.toDataURL(r),l(t,r,i,a)}catch(t){f(n,r,i,a)}}else c(n,r,i,a)}finally{d&&d(n,r,i,a)}},loadEventDeferDelay)}function s(){e(n,r,i,a),d&&d(n,r,i,a)}var g=new win.Image,f=function(){g=new win.Image,f=t,g.crossOrigin="Anonymous",g.onload=o,g.onerror=s,g.src=n};g.onload=o,g.onerror=s,g.src=n}function downloadSVGLocal(i,t,a,l){var e,o,c,d=!0,s=t.libURL||getOptions().exporting.libURL,n=doc.createElement("div"),g=t.type||"image/png",f=(t.filename||"chart")+"."+("image/svg+xml"===g?"svg":g.split("/")[1]),p=t.scale||1;function r(){n.innerHTML=i;var t,e=n.getElementsByTagName("text");[].forEach.call(e,function(e){["font-family","font-size"].forEach(function(t){!function(t,e){for(var o=t;o&&o!==n;){if(o.style[e]){t.style[e]=o.style[e];break}o=o.parentNode}}(e,t)}),e.style["font-family"]=e.style["font-family"]&&e.style["font-family"].split(" ").splice(-1),t=e.getElementsByTagName("title"),[].forEach.call(t,function(t){e.removeChild(t)})}),e=function(t,e){var o=t.width.baseVal.value+2*e,e=t.height.baseVal.value+2*e,e=new win.jsPDF(o<e?"p":"l","pt",[o,e]);[].forEach.call(t.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)});for(var n=t.querySelectorAll("linearGradient"),r=0;r<n.length;r++)for(var i=n[r].querySelectorAll("stop"),a=0;a<i.length&&"0"===i[a].getAttribute("offset")&&"0"===i[a+1].getAttribute("offset");)i[a].remove(),a++;return[].forEach.call(t.querySelectorAll("tspan"),function(t){"â€‹"===t.textContent&&(t.textContent=" ",t.setAttribute("dx",-5))}),win.svg2pdf(t,e,{removeInvalid:!0}),e.output("datauristring")}(n.firstChild,0);try{downloadURL(e,f),l&&l()}catch(t){a(t)}}if(s="/"!==s.slice(-1)?s+"/":s,"image/svg+xml"===g)try{e=void 0!==win.navigator.msSaveOrOpenBlob?((o=new MSBlobBuilder).append(i),o.getBlob("image/svg+xml")):svgToDataUrl(i),downloadURL(e,f),l&&l()}catch(t){a(t)}else"application/pdf"===g?win.jsPDF&&win.svg2pdf?r():(d=!0,getScript(s+"jspdf.js",function(){getScript(s+"svg2pdf.js",function(){r()})})):(e=svgToDataUrl(i),c=function(){try{domurl.revokeObjectURL(e)}catch(t){}},imageToDataUrl(e,g,{},p,function(t){try{downloadURL(t,f),l&&l()}catch(t){a(t)}},function(){function t(){win.canvg.Canvg.fromString(o,i).start();try{downloadURL(win.navigator.msSaveOrOpenBlob?e.msToBlob():e.toDataURL(g),f),l&&l()}catch(t){a(t)}finally{c()}}var e=doc.createElement("canvas"),o=e.getContext("2d"),n=i.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*p,r=i.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*p;e.width=n,e.height=r,win.canvg?t():(d=!0,getScript(s+"canvg.js",function(){t()}))},a,a,function(){d&&c()}))}H.CanVGRenderer={},Chart.prototype.getSVGForLocalExport=function(t,e,o,n){function r(t){return m.sanitizeSVG(t,d)}function i(){h===l.length&&n(r(c.innerHTML))}function a(t,e,o){++h,o.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",t),i()}var l,c,d,s,g,f,p,m=this,h=0;m.unbindGetSVG=addEvent(m,"getSVG",function(t){d=t.chartCopy.options,c=t.chartCopy.container.cloneNode(!0)}),m.getSVGForExport(t,e),l=c.getElementsByTagName("image");try{if(!l.length)return void n(r(c.innerHTML));for(g=0,f=l.length;g<f;++g)(p=(s=l[g]).getAttributeNS("http://www.w3.org/1999/xlink","href"))?imageToDataUrl(p,"image/png",{imageElement:s},t.scale,a,o,o,o):(++h,s.parentNode.removeChild(s),i())}catch(t){o(t)}m.unbindGetSVG()},Chart.prototype.exportChartLocal=function(t,e){function o(t){!1===r.fallbackToExportServer?r.error?r.error(r,t):error(28,!0):n.exportChart(r)}var n=this,r=merge(n.options.exporting,t);H.isMS&&n.styledMode&&(SVGRenderer.prototype.inlineWhitelist=[/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/]),H.isMS&&("application/pdf"===r.type||n.container.getElementsByTagName("image").length&&"image/svg+xml"!==r.type)||"application/pdf"===r.type&&[].some.call(n.container.getElementsByTagName("image"),function(t){t=t.getAttribute("href");return""!==t&&0!==t.indexOf("data:")})?o("Image type not supported for this chart/browser."):n.getSVGForLocalExport(r,e||{},o,function(t){-1<t.indexOf("<foreignObject")&&"image/svg+xml"!==r.type&&(H.isMS||"application/pdf"===r.type)?o("Image type not supportedfor charts with embedded HTML"):downloadSVGLocal(t,extend({filename:n.getFilename()},r),o,function(){return fireEvent(n,"exportChartLocalSuccess")})})},merge(!0,getOptions().exporting,{libURL:"https://code.highcharts.com/9.1.2/lib/",menuItemDefinitions:{downloadPNG:{textKey:"downloadPNG",onclick:function(){this.exportChartLocal()}},downloadJPEG:{textKey:"downloadJPEG",onclick:function(){this.exportChartLocal({type:"image/jpeg"})}},downloadSVG:{textKey:"downloadSVG",onclick:function(){this.exportChartLocal({type:"image/svg+xml"})}},downloadPDF:{textKey:"downloadPDF",onclick:function(){this.exportChartLocal({type:"application/pdf"})}}}}),H.downloadSVGLocal=downloadSVGLocal;