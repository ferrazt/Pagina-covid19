"use strict";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var doc=H.doc,win=H.win;import U from"../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent;import HTMLUtilities from"./Utils/HTMLUtilities.js";var getElement=HTMLUtilities.getElement;import EventProvider from"./Utils/EventProvider.js";function KeyboardNavigation(t,e){this.init(t,e)}addEvent(doc,"keydown",function(t){27===(t.which||t.keyCode)&&H.charts&&H.charts.forEach(function(t){t&&t.dismissPopupContent&&t.dismissPopupContent()})}),Chart.prototype.dismissPopupContent=function(){var t=this;fireEvent(this,"dismissPopupContent",{},function(){t.tooltip&&t.tooltip.hide(0),t.hideExportMenu()})},KeyboardNavigation.prototype={init:function(e,t){var i=this,n=this.eventProvider=new EventProvider;this.chart=e,this.components=t,this.modules=[],this.currentModuleIx=0,this.update(),n.addEvent(this.tabindexContainer,"keydown",function(t){return i.onKeydown(t)}),n.addEvent(this.tabindexContainer,"focus",function(t){return i.onFocus(t)}),["mouseup","touchend"].forEach(function(t){return n.addEvent(doc,t,function(){return i.onMouseUp()})}),["mousedown","touchstart"].forEach(function(t){return n.addEvent(e.renderTo,t,function(){i.isClickingChart=!0})}),n.addEvent(e.renderTo,"mouseover",function(){i.pointerIsOverChart=!0}),n.addEvent(e.renderTo,"mouseout",function(){i.pointerIsOverChart=!1}),this.modules.length&&this.modules[0].init(1)},update:function(t){var e=this.chart.options.accessibility,e=e&&e.keyboardNavigation,i=this.components;this.updateContainerTabindex(),e&&e.enabled&&t&&t.length?(this.modules=t.reduce(function(t,e){e=i[e].getKeyboardNavigation();return t.concat(e)},[]),this.updateExitAnchor()):(this.modules=[],this.currentModuleIx=0,this.removeExitAnchor())},onFocus:function(t){var e=this.chart,t=t.relatedTarget&&e.container.contains(t.relatedTarget);this.exiting||this.tabbingInBackwards||this.isClickingChart||t||!this.modules[0]||this.modules[0].init(1),this.exiting=!1},onMouseUp:function(){var t,e;delete this.isClickingChart,this.keyboardReset||this.pointerIsOverChart||(t=this.chart,(e=this.modules&&this.modules[this.currentModuleIx||0])&&e.terminate&&e.terminate(),t.focusElement&&t.focusElement.removeFocusBorder(),this.currentModuleIx=0,this.keyboardReset=!0)},onKeydown:function(t){var e,i=t||win.event,n=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];this.keyboardReset=!1,this.exiting=!1,n&&((t=n.run(i))===n.response.success?e=!0:t===n.response.prev?e=this.prev():t===n.response.next&&(e=this.next()),e&&(i.preventDefault(),i.stopPropagation()))},prev:function(){return this.move(-1)},next:function(){return this.move(1)},move:function(t){var e=this.modules&&this.modules[this.currentModuleIx];e&&e.terminate&&e.terminate(t),this.chart.focusElement&&this.chart.focusElement.removeFocusBorder(),this.currentModuleIx+=t;e=this.modules&&this.modules[this.currentModuleIx];if(e){if(e.validate&&!e.validate())return this.move(t);if(e.init)return e.init(t),!0}return this.currentModuleIx=0,this.exiting=!0,(0<t?this.exitAnchor:this.tabindexContainer).focus(),!1},updateExitAnchor:function(){var t="highcharts-end-of-chart-marker-"+this.chart.index,t=getElement(t);this.removeExitAnchor(),t?(this.makeElementAnExitAnchor(t),this.exitAnchor=t):this.createExitAnchor()},updateContainerTabindex:function(){var t=this.chart.options.accessibility,e=t&&t.keyboardNavigation,i=!(e&&!1===e.enabled),n=this.chart,t=n.container,e=n.renderTo.hasAttribute("tabindex")?(t.removeAttribute("tabindex"),n.renderTo):t,t=(this.tabindexContainer=e).getAttribute("tabindex");i&&!t?e.setAttribute("tabindex","0"):i||n.container.removeAttribute("tabindex")},makeElementAnExitAnchor:function(t){var e=this.tabindexContainer.getAttribute("tabindex")||0;t.setAttribute("class","highcharts-exit-anchor"),t.setAttribute("tabindex",e),t.setAttribute("aria-hidden",!1),this.addExitAnchorEventsToEl(t)},createExitAnchor:function(){var t=this.chart,e=this.exitAnchor=doc.createElement("div");t.renderTo.appendChild(e),this.makeElementAnExitAnchor(e)},removeExitAnchor:function(){this.exitAnchor&&this.exitAnchor.parentNode&&(this.exitAnchor.parentNode.removeChild(this.exitAnchor),delete this.exitAnchor)},addExitAnchorEventsToEl:function(t){var e=this.chart,i=this;this.eventProvider.addEvent(t,"focus",function(t){t=t||win.event;!(t.relatedTarget&&e.container.contains(t.relatedTarget)||i.exiting)?(i.tabbingInBackwards=!0,i.tabindexContainer.focus(),delete i.tabbingInBackwards,t.preventDefault(),i.modules&&i.modules.length&&(i.currentModuleIx=i.modules.length-1,(t=i.modules[i.currentModuleIx])&&t.validate&&!t.validate()?i.prev():t&&t.init(-1))):i.exiting=!1})},destroy:function(){this.removeExitAnchor(),this.eventProvider.removeAddedEvents(),this.chart.container.removeAttribute("tabindex")}};export default KeyboardNavigation;