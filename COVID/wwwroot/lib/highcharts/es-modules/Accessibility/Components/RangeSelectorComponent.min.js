"use strict";import AccessibilityComponent from"../AccessibilityComponent.js";import ChartUtilities from"../Utils/ChartUtilities.js";var unhideChartElementFromAT=ChartUtilities.unhideChartElementFromAT,getAxisRangeDescription=ChartUtilities.getAxisRangeDescription;import Announcer from"../Utils/Announcer.js";import Chart from"../../Core/Chart/Chart.js";import HTMLUtilities from"../Utils/HTMLUtilities.js";var setElAttrs=HTMLUtilities.setElAttrs;import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import U from"../../Core/Utilities.js";import RangeSelector from"../../Extensions/RangeSelector.js";var addEvent=U.addEvent,extend=U.extend;function shouldRunInputNavigation(t){return Boolean(t.rangeSelector&&t.rangeSelector.inputGroup&&"hidden"!==t.rangeSelector.inputGroup.element.getAttribute("visibility")&&!1!==t.options.rangeSelector.inputEnabled&&t.rangeSelector.minInput&&t.rangeSelector.maxInput)}Chart.prototype.highlightRangeSelectorButton=function(t){var e=this.rangeSelector&&this.rangeSelector.buttons||[],n=this.highlightedRangeSelectorItemIx,o=this.rangeSelector&&this.rangeSelector.selected;return void 0!==n&&e[n]&&n!==o&&e[n].setState(this.oldRangeSelectorItemState||0),!!e[this.highlightedRangeSelectorItemIx=t]&&(this.setFocusToElement(e[t].box,e[t].element),t!==o&&(this.oldRangeSelectorItemState=e[t].state,e[t].setState(1)),!0)},addEvent(RangeSelector,"afterBtnClick",function(){if(this.chart.accessibility&&this.chart.accessibility.components.rangeSelector)return this.chart.accessibility.components.rangeSelector.onAfterBtnClick()});var RangeSelectorComponent=function(){};RangeSelectorComponent.prototype=new AccessibilityComponent,extend(RangeSelectorComponent.prototype,{init:function(){var t=this.chart;this.announcer=new Announcer(t,"polite")},onChartUpdate:function(){var n=this.chart,o=this,i=n.rangeSelector;i&&(this.updateSelectorVisibility(),this.setDropdownAttrs(),i.buttons&&i.buttons.length&&i.buttons.forEach(function(t){o.setRangeButtonAttrs(t)}),i.maxInput&&i.minInput&&["minInput","maxInput"].forEach(function(t,e){t=i[t];t&&(unhideChartElementFromAT(n,t),o.setRangeInputAttrs(t,"accessibility.rangeSelector."+(e?"max":"min")+"InputLabel"))}))},updateSelectorVisibility:function(){function e(t){return t.setAttribute("aria-hidden",!0)}var n=this.chart,t=n.rangeSelector,o=t&&t.dropdown,i=t&&t.buttons||[];t&&t.hasVisibleDropdown&&o?(unhideChartElementFromAT(n,o),i.forEach(function(t){return e(t.element)})):(o&&e(o),i.forEach(function(t){return unhideChartElementFromAT(n,t.element)}))},setDropdownAttrs:function(){var t=this.chart,e=t.rangeSelector&&t.rangeSelector.dropdown;e&&(t=t.langFormat("accessibility.rangeSelector.dropdownLabel",{rangeTitle:t.options.lang.rangeSelectorZoom}),e.setAttribute("aria-label",t),e.setAttribute("tabindex",-1))},setRangeButtonAttrs:function(t){setElAttrs(t.element,{tabindex:-1,role:"button"})},setRangeInputAttrs:function(t,e){var n=this.chart;setElAttrs(t,{tabindex:-1,"aria-label":n.langFormat(e,{chart:n})})},onButtonNavKbdArrowKey:function(t,e){var n=t.response,o=this.keyCodes,i=this.chart,r=i.options.accessibility.keyboardNavigation.wrapAround,o=e===o.left||e===o.up?-1:1;return i.highlightRangeSelectorButton(i.highlightedRangeSelectorItemIx+o)?n.success:r?(t.init(o),n.success):n[0<o?"next":"prev"]},onButtonNavKbdClick:function(t){var e=t.response,t=this.chart;return 3===t.oldRangeSelectorItemState||this.fakeClickEvent(t.rangeSelector.buttons[t.highlightedRangeSelectorItemIx].element),e.success},onAfterBtnClick:function(){var t=this.chart,e=getAxisRangeDescription(t.xAxis[0]),e=t.langFormat("accessibility.rangeSelector.clickButtonAnnouncement",{chart:t,axisRangeDescription:e});e&&this.announcer.announce(e)},onInputKbdMove:function(t){var e=this.chart,n=e.rangeSelector,o=e.highlightedInputRangeIx=(e.highlightedInputRangeIx||0)+t;1<o||o<0?e.accessibility&&(e.accessibility.keyboardNavigation.tabindexContainer.focus(),e.accessibility.keyboardNavigation[t<0?"prev":"next"]()):n&&(t=n[o?"maxDateBox":"minDateBox"],o=n[o?"maxInput":"minInput"],t&&o&&e.setFocusToElement(t,o))},onInputNavInit:function(t){var e,n,o=this,i=this,r=this.chart,a=0<t?0:1,s=r.rangeSelector,c=s&&s[a?"maxDateBox":"minDateBox"],l=s&&s.minInput,t=s&&s.maxInput,s=a?t:l;r.highlightedInputRangeIx=a,c&&l&&t&&(r.setFocusToElement(c,s),this.removeInputKeydownHandler&&this.removeInputKeydownHandler(),e=addEvent(l,"keydown",l=function(t){(t.which||t.keyCode)===o.keyCodes.tab&&(t.preventDefault(),t.stopPropagation(),i.onInputKbdMove(t.shiftKey?-1:1))}),n=addEvent(t,"keydown",l),this.removeInputKeydownHandler=function(){e(),n()})},onInputNavTerminate:function(){var t=this.chart.rangeSelector||{};t.maxInput&&t.hideInput("max"),t.minInput&&t.hideInput("min"),this.removeInputKeydownHandler&&(this.removeInputKeydownHandler(),delete this.removeInputKeydownHandler)},initDropdownNav:function(){var e=this,n=this.chart,t=n.rangeSelector,o=t&&t.dropdown;t&&o&&(n.setFocusToElement(t.buttonGroup,o),this.removeDropdownKeydownHandler&&this.removeDropdownKeydownHandler(),this.removeDropdownKeydownHandler=addEvent(o,"keydown",function(t){(t.which||t.keyCode)===e.keyCodes.tab&&(t.preventDefault(),t.stopPropagation(),n.accessibility&&(n.accessibility.keyboardNavigation.tabindexContainer.focus(),n.accessibility.keyboardNavigation[t.shiftKey?"prev":"next"]()))}))},getRangeSelectorButtonNavigation:function(){var n=this.chart,t=this.keyCodes,o=this;return new KeyboardNavigationHandler(n,{keyCodeMap:[[[t.left,t.right,t.up,t.down],function(t){return o.onButtonNavKbdArrowKey(this,t)}],[[t.enter,t.space],function(){return o.onButtonNavKbdClick(this)}]],validate:function(){return!!(n.rangeSelector&&n.rangeSelector.buttons&&n.rangeSelector.buttons.length)},init:function(t){var e=n.rangeSelector;e&&e.hasVisibleDropdown?o.initDropdownNav():e&&(e=e.buttons.length-1,n.highlightRangeSelectorButton(0<t?0:e))},terminate:function(){o.removeDropdownKeydownHandler&&(o.removeDropdownKeydownHandler(),delete o.removeDropdownKeydownHandler)}})},getRangeSelectorInputNavigation:function(){var t=this.chart,e=this;return new KeyboardNavigationHandler(t,{keyCodeMap:[],validate:function(){return shouldRunInputNavigation(t)},init:function(t){e.onInputNavInit(t)},terminate:function(){e.onInputNavTerminate()}})},getKeyboardNavigation:function(){return[this.getRangeSelectorButtonNavigation(),this.getRangeSelectorInputNavigation()]},destroy:function(){this.removeDropdownKeydownHandler&&this.removeDropdownKeydownHandler(),this.removeInputKeydownHandler&&this.removeInputKeydownHandler(),this.announcer&&this.announcer.destroy()}});export default RangeSelectorComponent;